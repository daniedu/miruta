"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[372],{7199:(t,e,i)=>{function o(){return(o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var o in i)({}).hasOwnProperty.call(i,o)&&(t[o]=i[o])}return t}).apply(null,arguments)}i.d(e,{N$:()=>ts,QN:()=>tS,bS:()=>tz,b_:()=>$,cF:()=>F,hV:()=>tX,iA:()=>ti,mG:()=>Z}),function(t){t.Commit="commit",t.Provisional="provisional",t.Finish="finish"}(tY||(tY={}));let r={SELECTED:"selected",MID_POINT:"midPoint",SELECTION_POINT_FEATURE_ID:"selectionPointFeatureId",SELECTION_POINT:"selectionPoint"},s={MODE:"mode",CURRENTLY_DRAWING:"currentlyDrawing",EDITED:"edited",CLOSING_POINT:"closingPoint",SNAPPING_POINT:"snappingPoint",COORDINATE_POINT:"coordinatePoint",COORDINATE_POINT_FEATURE_ID:"coordinatePointFeatureId",COORDINATE_POINT_IDS:"coordinatePointIds",PROVISIONAL_COORDINATE_COUNT:"provisionalCoordinateCount",COMMITTED_COORDINATE_COUNT:"committedCoordinateCount",MARKER:"marker"};function n(t){return!!(t&&"object"==typeof t&&null!==t&&!Array.isArray(t))}function a(t){return!!(t&&"object"==typeof t&&"properties"in t&&"object"==typeof t.properties&&null!==t.properties&&"mode"in t.properties)}function d(t){return!!("number"==typeof t&&!isNaN(new Date(t).valueOf()))}!function(t){t.Drawing="drawing",t.Select="select",t.Static="static",t.Render="render"}(tK||(tK={}));let l={rightClick:!0,contextMenu:!1,leftClick:!0,onDragStart:!0,onDrag:!0,onDragEnd:!0};class h{get state(){return this._state}set state(t){throw Error("Please use the modes lifecycle methods")}get styles(){return this._styles}set styles(t){if("object"!=typeof t)throw Error("Styling must be an object");this.onStyleChange&&this.onStyleChange([],"styling"),this._styles=t}registerBehaviors(t){}constructor(t,e=!1){this._state="unregistered",this._styles={},this.pointerEvents=l,this.behaviors=[],this.validate=void 0,this.pointerDistance=40,this.coordinatePrecision=void 0,this.onStyleChange=void 0,this.store=void 0,this.projection="web-mercator",this.setDoubleClickToZoom=void 0,this.unproject=void 0,this.project=void 0,this.setCursor=void 0,this.type=tK.Drawing,this.mode="base",e||this.updateOptions(t)}updateOptions(t){null!=t&&t.styles&&(this.styles=o({},this._styles,t.styles)),null!=t&&t.pointerDistance&&(this.pointerDistance=t.pointerDistance),null!=t&&t.validation&&(this.validate=t&&t.validation),null!=t&&t.projection&&(this.projection=t.projection),void 0!==(null==t?void 0:t.pointerEvents)&&(this.pointerEvents=t.pointerEvents)}allowPointerEvent(t,e){return"boolean"==typeof t?t:"function"!=typeof t||t(e)}setDrawing(){if("started"!==this._state)throw Error("Mode must be unregistered or stopped to start");this._state="drawing"}setStarted(){if("stopped"!==this._state&&"registered"!==this._state&&"drawing"!==this._state&&"selecting"!==this._state)throw Error("Mode must be unregistered or stopped to start");this._state="started",this.setDoubleClickToZoom(!1)}setStopped(){if("started"!==this._state)throw Error("Mode must be started to be stopped");this._state="stopped",this.setDoubleClickToZoom(!0)}register(t){if("unregistered"!==this._state)throw Error("Can not register unless mode is unregistered");this._state="registered",this.store=t.store,this.store.registerOnChange(t.onChange),this.setDoubleClickToZoom=t.setDoubleClickToZoom,this.project=t.project,this.unproject=t.unproject,this.onSelect=t.onSelect,this.onDeselect=t.onDeselect,this.setCursor=t.setCursor,this.onStyleChange=t.onChange,this.onFinish=t.onFinish,this.coordinatePrecision=t.coordinatePrecision,this.registerBehaviors({mode:t.mode,store:this.store,project:this.project,unproject:this.unproject,pointerDistance:this.pointerDistance,coordinatePrecision:t.coordinatePrecision,projection:this.projection})}validateFeature(t){return this.performFeatureValidation(t)}afterFeatureAdded(t){}afterFeatureUpdated(t){}performFeatureValidation(t){if("unregistered"===this._state)throw Error("Mode must be registered");let e=function(t,e){let i;if(n(t))if(null==t.id)i="Feature has no id";else if("string"!=typeof t.id&&"number"!=typeof t.id)i="Feature must be string or number as per GeoJSON spec";else if(e(t.id))if(n(t.geometry))if(n(t.properties))if("string"==typeof t.geometry.type&&["Polygon","LineString","Point"].includes(t.geometry.type))if(Array.isArray(t.geometry.coordinates)){if(!t.properties.mode||"string"!=typeof t.properties.mode)return{valid:!1,reason:"Feature does not have a valid mode property"}}else i="Feature coordinates is not an array";else i="Feature is not Point, LineString or Polygon";else i="Feature has no properties";else i="Feature has no geometry";else i="Feature must match the id strategy (default is UUID4)";else i="Feature is not object";return i?{valid:!1,reason:i}:{valid:!0}}(t,this.store.idStrategy.isValidId);if(this.validate){let i=this.validate(t,{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Provisional});return{valid:e.valid&&i.valid,reason:i.reason}}return{valid:e.valid,reason:e.reason}}validateModeFeature(t,e){let i=this.performFeatureValidation(t);return i.valid?t.properties.mode!==this.mode?{valid:!1,reason:"Feature mode property does not match the mode being added to"}:e(t):{valid:!1,reason:i.reason}}onFinish(t,e){}onDeselect(t){}onSelect(t){}onKeyDown(t){}onKeyUp(t){}onMouseMove(t){}onClick(t){}onDragStart(t,e){}onDrag(t,e){}onDragEnd(t,e){}getHexColorStylingValue(t,e,i){return this.getStylingValue(t,e,i)}getNumericStylingValue(t,e,i){return this.getStylingValue(t,e,i)}getUrlStylingValue(t,e,i){return this.getStylingValue(t,e,i)}getStylingValue(t,e,i){return void 0===t?e:"function"==typeof t?t(i):t}}class c extends h{constructor(...t){super(...t),this.type=tK.Select}}function p(t,e){let i=t=>t*Math.PI/180,o=i(t[1]),r=i(t[0]),s=i(e[1]),n=s-o,a=i(e[0])-r,d=Math.sin(n/2)*Math.sin(n/2)+Math.cos(o)*Math.cos(s)*Math.sin(a/2)*Math.sin(a/2);return 2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))*6371e3/1e3}function u(t){return t%360*Math.PI/180}function g(t){return t%(2*Math.PI)*180/Math.PI}function y(t,e=9){let i=Math.pow(10,e);return Math.round(t*i)/i}let m=(t,e)=>({x:0===t?0:.017453292519943295*t*6378137,y:0===e?0:6378137*Math.log(Math.tan(Math.PI/4+.017453292519943295*e/2))}),f=(t,e)=>({lng:0===t?0:t/6378137*57.29577951308232,lat:0===e?0:(2*Math.atan(Math.exp(e/6378137))-Math.PI/2)*57.29577951308232});function v(t){let{center:e,radiusKilometers:i,coordinatePrecision:o}=t,r=t.steps?t.steps:64,s=[];for(let t=0;t<r;t++){let n=function(t,e,i){let o=u(t[0]),r=u(t[1]),s=u(i),n=e/6371.0088,a=Math.asin(Math.sin(r)*Math.cos(n)+Math.cos(r)*Math.sin(n)*Math.cos(s));return[g(o+Math.atan2(Math.sin(s)*Math.sin(n)*Math.cos(r),Math.cos(n)-Math.sin(r)*Math.sin(a))),g(a)]}(e,i,-360*t/r);s.push([y(n[0],o),y(n[1],o)])}return s.push(s[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[s]},properties:{}}}function C(t){let e;if("Polygon"===t.geometry.type)e=t.geometry.coordinates;else{if("LineString"!==t.geometry.type)throw Error("Self intersects only accepts Polygons and LineStrings");e=[t.geometry.coordinates]}let i=[];for(let t=0;t<e.length;t++)for(let o=0;o<e[t].length-1;o++)for(let r=0;r<e.length;r++)for(let s=0;s<e[r].length-1;s++)!function(t,o,r,s){let n,a,d=e[t][o],l=e[t][o+1],h=e[r][s],c=e[r][s+1],p=function(t,e,i,o){if(P(t,i)||P(t,o)||P(e,i)||P(o,i))return null;let r=t[0],s=t[1],n=e[0],a=e[1],d=i[0],l=i[1],h=o[0],c=o[1],p=(r-n)*(l-c)-(s-a)*(d-h);return 0===p?null:[((r*a-s*n)*(d-h)-(r-n)*(d*c-l*h))/p,((r*a-s*n)*(l-c)-(s-a)*(d*c-l*h))/p]}(d,l,h,c);if(null!==p){var u;n=l[0]!==d[0]?(p[0]-d[0])/(l[0]-d[0]):(p[1]-d[1])/(l[1]-d[1]),a=c[0]!==h[0]?(p[0]-h[0])/(c[0]-h[0]):(p[1]-h[1])/(c[1]-h[1]),n<0||n>1||(u=a)<0||u>1||(p.toString(),i.push(p))}}(t,o,r,s);return i.length>0}function P(t,e){return t[0]===e[0]&&t[1]===e[1]}function I(t,e){return E(t[0])<=e&&E(t[1])<=e}function x(t){var e,i;return 2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1]&&1/0!==t[0]&&1/0!==t[1]&&(i=t[0])>=-180&&i<=180&&(e=t[1])>=-90&&e<=90}function E(t){let e=1,i=0;for(;Math.round(t*e)/e!==t;)e*=10,i++;return i}function M(t,e){var i,o;if("Polygon"!==t.geometry.type)return{valid:!1,reason:"Feature is not a Polygon"};if(1!==t.geometry.coordinates.length)return{valid:!1,reason:"Feature has holes"};if(t.geometry.coordinates[0].length<4)return{valid:!1,reason:"Feature has less than 4 coordinates"};for(let i=0;i<t.geometry.coordinates[0].length;i++){if(!x(t.geometry.coordinates[0][i]))return{valid:!1,reason:"Feature has invalid coordinates"};if(!I(t.geometry.coordinates[0][i],e))return{valid:!1,reason:"Feature has coordinates with excessive precision"}}return(i=t.geometry.coordinates[0][0])[0]!==(o=t.geometry.coordinates[0][t.geometry.coordinates[0].length-1])[0]||i[1]!==o[1]?{valid:!1,reason:"Feature coordinates are not closed"}:{valid:!0}}function S(t,e){let i=M(t,e);return i.valid?C(t)?{valid:!1,reason:"Feature intersects itself"}:{valid:!0}:i}let D={cancel:"Escape",finish:"Enter"},_={start:"crosshair"};class F extends h{constructor(t){super(t,!0),this.mode="circle",this.center=void 0,this.clickCount=0,this.currentCircleId=void 0,this.keyEvents=D,this.cursors=_,this.startingRadiusKilometers=1e-5,this.cursorMovedAfterInitialCursorDown=!1,this.updateOptions(t)}updateOptions(t){super.updateOptions(t),null!=t&&t.cursors&&(this.cursors=o({},this.cursors,t.cursors)),null===(null==t?void 0:t.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=t&&t.keyEvents&&(this.keyEvents=o({},this.keyEvents,t.keyEvents)),null!=t&&t.startingRadiusKilometers&&(this.startingRadiusKilometers=t.startingRadiusKilometers)}close(){if(void 0===this.currentCircleId)return;this.store.updateProperty([{id:this.currentCircleId,property:s.CURRENTLY_DRAWING,value:void 0}]);let t=this.currentCircleId;if(this.validate&&t){let e=this.store.getGeometryCopy(t);if(!this.validate({type:"Feature",id:t,geometry:e,properties:{}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Finish}).valid)return}this.cursorMovedAfterInitialCursorDown=!1,this.center=void 0,this.currentCircleId=void 0,this.clickCount=0,"drawing"===this.state&&this.setStarted(),this.onFinish(t,{mode:this.mode,action:"draw"})}start(){this.setStarted(),this.setCursor(this.cursors.start)}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onClick(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))if(0===this.clickCount){this.center=[t.lng,t.lat];let e=v({center:this.center,radiusKilometers:this.startingRadiusKilometers,coordinatePrecision:this.coordinatePrecision}),[i]=this.store.create([{geometry:e.geometry,properties:{mode:this.mode,radiusKilometers:this.startingRadiusKilometers,[s.CURRENTLY_DRAWING]:!0}}]);this.currentCircleId=i,this.clickCount++,this.cursorMovedAfterInitialCursorDown=!1,this.setDrawing()}else 1===this.clickCount&&this.center&&void 0!==this.currentCircleId&&this.cursorMovedAfterInitialCursorDown&&this.updateCircle(t),this.close()}onMouseMove(t){this.cursorMovedAfterInitialCursorDown=!0,this.updateCircle(t)}onKeyDown(){}onKeyUp(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()}onDragStart(){}onDrag(){}onDragEnd(){}cleanUp(){let t=this.currentCircleId;this.center=void 0,this.currentCircleId=void 0,this.clickCount=0,"drawing"===this.state&&this.setStarted();try{void 0!==t&&this.store.delete([t])}catch(t){}}styleFeature(t){let e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"Polygon"===t.geometry.type&&t.properties.mode===this.mode&&(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=10),e}validateFeature(t){return this.validateModeFeature(t,t=>S(t,this.coordinatePrecision))}updateCircle(t){if(1===this.clickCount&&this.center&&this.currentCircleId){let e,i=p(this.center,[t.lng,t.lat]);if("web-mercator"===this.projection){let o=function(t,e){let i=1e3*p(t,e);if(0===i)return 1;let{x:o,y:r}=m(t[0],t[1]),{x:s,y:n}=m(e[0],e[1]);return Math.sqrt(Math.pow(s-o,2)+Math.pow(n-r,2))/i}(this.center,[t.lng,t.lat]);e=function(t){let{center:e,radiusKilometers:i,coordinatePrecision:o}=t,r=t.steps?t.steps:64,s=1e3*i,[n,a]=e,{x:d,y:l}=m(n,a),h=[];for(let t=0;t<r;t++){let e=360*t/r*Math.PI/180,[i,n]=[d+s*Math.cos(e),l+s*Math.sin(e)],{lng:a,lat:c}=f(i,n);h.push([y(a,o),y(c,o)])}return h.push(h[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[h]},properties:{}}}({center:this.center,radiusKilometers:i*o,coordinatePrecision:this.coordinatePrecision})}else{if("globe"!==this.projection)throw Error("Invalid projection");e=v({center:this.center,radiusKilometers:i,coordinatePrecision:this.coordinatePrecision})}(!this.validate||this.validate({type:"Feature",id:this.currentCircleId,geometry:e.geometry,properties:{radiusKilometers:i}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Provisional}).valid)&&(this.store.updateGeometry([{id:this.currentCircleId,geometry:e.geometry}]),this.store.updateProperty([{id:this.currentCircleId,property:"radiusKilometers",value:i}]))}}afterFeatureUpdated(t){this.currentCircleId===t.id&&(this.cursorMovedAfterInitialCursorDown=!1,this.center=void 0,this.currentCircleId=void 0,this.clickCount=0,"drawing"===this.state&&this.setStarted())}}let b=(t,e)=>{let{x:i,y:o}=t,{x:r,y:s}=e,n=r-i,a=s-o;return Math.sqrt(a*a+n*n)};function O(t){if(!function(t){let e=t.coordinates[0],i=0;for(let t=0;t<e.length-1;t++){let[o,r]=e[t],[s,n]=e[t+1];i+=(s-o)*(n+r)}return i<0}(t))return{type:"Polygon",coordinates:[t.coordinates[0].reverse()]}}class w{constructor({store:t,mode:e,project:i,unproject:o,pointerDistance:r,coordinatePrecision:s,projection:n}){this.store=void 0,this.mode=void 0,this.project=void 0,this.unproject=void 0,this.pointerDistance=void 0,this.coordinatePrecision=void 0,this.projection=void 0,this.store=t,this.mode=e,this.project=i,this.unproject=o,this.pointerDistance=r,this.coordinatePrecision=s,this.projection=n}}function k({unproject:t,point:e,pointerDistance:i}){let o=i/2,{x:r,y:s}=e;return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[t(r-o,s-o),t(r+o,s-o),t(r+o,s+o),t(r-o,s+o),t(r-o,s-o)].map(t=>[t.lng,t.lat])]}}}class N extends w{constructor(t){super(t)}create(t){let{containerX:e,containerY:i}=t;return k({unproject:this.unproject,point:{x:e,y:i},pointerDistance:this.pointerDistance})}}class T extends w{constructor(t){super(t)}measure(t,e){let{x:i,y:o}=this.project(e[0],e[1]);return b({x:i,y:o},{x:t.containerX,y:t.containerY})}}class j extends w{constructor(t,e,i){super(t),this.config=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.getSnappableCoordinateFirstClick=t=>this.getSnappable(t,t=>!!(t.properties&&t.properties.mode===this.mode)).coordinate,this.getSnappableCoordinate=(t,e)=>this.getSnappable(t,t=>!!(t.properties&&t.properties.mode===this.mode&&t.id!==e)).coordinate,this.config=t,this.pixelDistance=e,this.clickBoundingBox=i}getSnappable(t,e){let i=this.clickBoundingBox.create(t),o=this.store.search(i,e),r={featureId:void 0,featureCoordinateIndex:void 0,coordinate:void 0,minDist:1/0};return o.forEach(e=>{let i;if("Polygon"===e.geometry.type)i=e.geometry.coordinates[0];else{if("LineString"!==e.geometry.type)return;i=e.geometry.coordinates}i.forEach((i,o)=>{let s=this.pixelDistance.measure(t,i);s<r.minDist&&s<this.pointerDistance&&(r.coordinate=i,r.minDist=s,r.featureId=e.id,r.featureCoordinateIndex=o)})}),r}}function B(t,e,i){let o=u(t[0]),r=u(t[1]),s=u(i),n=e/6371.0088,a=Math.asin(Math.sin(r)*Math.cos(n)+Math.cos(r)*Math.sin(n)*Math.cos(s));return[g(o+Math.atan2(Math.sin(s)*Math.sin(n)*Math.cos(r),Math.cos(n)-Math.sin(r)*Math.sin(a))),g(a)]}function W(t,e){let i=u(t[0]),o=u(e[0]),r=u(t[1]),s=u(e[1]);return g(Math.atan2(Math.sin(o-i)*Math.cos(s),Math.cos(r)*Math.sin(s)-Math.sin(r)*Math.cos(s)*Math.cos(o-i)))}function G(t){return Math.PI/180*t}function R(t){return 180/Math.PI*t}class L extends w{constructor(t){super(t),this.config=void 0,this.config=t}generateInsertionCoordinates(t,e,i){let o=[t,e],r=0;for(let t=0;t<o.length-1;t++)r+=p(o[0],o[1]);if(r<=i)return o;let s=r/i-1;Number.isInteger(s)||(s=Math.floor(s)+1);let n=[];for(let t=0;t<s;t++){let e=function(t,e,i){let o=[],r=t.length,s,n,a,d=0;for(let r=0;r<t.length&&!(e>=d&&r===t.length-1);r++){if(d>e&&0===o.length){if(!(s=e-d))return o.push(t[r]),o;n=W(t[r],t[r-1])-180,a=B(t[r],s,n),o.push(a)}if(d>=i)return(s=i-d)?(n=W(t[r],t[r-1])-180,a=B(t[r],s,n),o.push(a)):o.push(t[r]),o;if(d>=e&&o.push(t[r]),r===t.length-1)return o;d+=p(t[r],t[r+1])}if(d<e&&t.length===r)throw Error("Start position is beyond line");let l=t[t.length-1];return[l,l]}(o,i*t,i*(t+1));n.push(e)}let a=[];for(let t=0;t<n.length;t++)a.push(n[t][1]);return this.limitCoordinates(a)}generateInsertionGeodesicCoordinates(t,e,i){let o=p(t,e),r=function(t,e,i){let o=[],r=G(t[1]),s=G(t[0]),n=G(e[1]),a=G(e[0]);i+=1;let d=2*Math.asin(Math.sqrt(Math.sin((n-r)/2)**2+Math.cos(r)*Math.cos(n)*Math.sin((a-s)/2)**2));if(0===d||isNaN(d))return o;for(let t=0;t<=i;t++){let e=t/i,l=Math.sin((1-e)*d)/Math.sin(d),h=Math.sin(e*d)/Math.sin(d),c=l*Math.cos(r)*Math.cos(s)+h*Math.cos(n)*Math.cos(a),p=l*Math.cos(r)*Math.sin(s)+h*Math.cos(n)*Math.sin(a),u=l*Math.sin(r)+h*Math.sin(n);if(isNaN(c)||isNaN(p)||isNaN(u))continue;let g=Math.atan2(u,Math.sqrt(c**2+p**2)),y=Math.atan2(p,c);isNaN(g)||isNaN(y)||o.push([R(y),R(g)])}return o.slice(1,-1)}(t,e,Math.floor(o/i));return this.limitCoordinates(r)}limitCoordinates(t){return t.map(t=>[y(t[0],this.config.coordinatePrecision),y(t[1],this.config.coordinatePrecision)])}}function A(t,e){return t[0]===e[0]&&t[1]===e[1]}function U(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2))}function V(t,e){return Math.acos(Math.min(Math.max(function(t,e){let[i,o,r]=t,[s,n,a]=e;return i*s+o*n+r*a}(t,e)/(U(t)*U(e)),-1),1))}function Y(t){let e=u(t[1]),i=u(t[0]);return[Math.cos(e)*Math.cos(i),Math.cos(e)*Math.sin(i),Math.sin(e)]}function K(t){let[e,i,o]=t,r=g(Math.asin(o));return[g(Math.atan2(i,e)),r]}class X extends w{constructor(t,e,i){super(t),this.config=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.getSnappableCoordinateFirstClick=t=>{let e=this.getSnappable(t,t=>!!(t.properties&&t.properties.mode===this.mode));return e.coordinate?[y(e.coordinate[0],this.config.coordinatePrecision),y(e.coordinate[1],this.config.coordinatePrecision)]:void 0},this.getSnappableCoordinate=(t,e)=>{let i=this.getSnappable(t,t=>!!(t.properties&&t.properties.mode===this.mode&&t.id!==e));return i.coordinate?[y(i.coordinate[0],this.config.coordinatePrecision),y(i.coordinate[1],this.config.coordinatePrecision)]:void 0},this.config=t,this.pixelDistance=e,this.clickBoundingBox=i}getSnappable(t,e){let i=this.clickBoundingBox.create(t),o=this.store.search(i,e),r={featureId:void 0,featureCoordinateIndex:void 0,coordinate:void 0,minDistance:1/0};return o.forEach(e=>{let i,o;if("Polygon"===e.geometry.type)i=e.geometry.coordinates[0];else{if("LineString"!==e.geometry.type)return;i=e.geometry.coordinates}let s=[];for(let t=0;t<i.length-1;t++)s.push([i[t],i[t+1]]);let n=[t.lng,t.lat];if("web-mercator"===this.config.projection?o=function(t,e){let i=[1/0,1/0],o=1/0,r=0;for(let s of e){let n=s[0],a=s[1],d,l=1/0,h=m(n[0],n[1]),c=m(a[0],a[1]),p=m(t[0],t[1]);if(n[0]===t[0]&&n[1]===t[1])d=n;else if(a[0]===t[0]&&a[1]===t[1])d=a;else{let{x:t,y:e}=function(t,e,i){let o=e.x-t.x,r=e.y-t.y,s=Math.max(0,Math.min(1,((i.x-t.x)*o+(i.y-t.y)*r)/(o*o+r*r)));return{x:t.x+s*o,y:t.y+s*r}}(h,c,p),{lng:i,lat:o}=f(t,e);d=[i,o]}d&&(l=b(p,m(d[0],d[1])))<o&&(i=d,o=l,r=e.indexOf(s))}return 1/0===o?void 0:{coordinate:i,lineIndex:r,distance:o}}(n,s):"globe"===this.config.projection&&(o=function(t,e){let i=[1/0,1/0],o=1/0,r=0;for(let s of e){let n=s[0],a=s[1],d,l=1/0;n[0]===t[0]&&n[1]===t[1]?d=n:a[0]===t[0]&&a[1]===t[1]?d=a:[d]=function(t,e,i){let o,r=Y(t),s=Y(e),[n,a,d]=Y(i),[l,h,c]=function(t,e){let[i,o,r]=t,[s,n,a]=e;return[o*a-r*n,r*s-i*a,i*n-o*s]}(r,s),u=h*d-c*a,g=c*n-l*d,y=l*a-h*n,m=y*h-g*c,f=u*c-y*l,v=g*l-u*h,C=1/Math.sqrt(Math.pow(m,2)+Math.pow(f,2)+Math.pow(v,2)),P=[m*C,f*C,v*C],I=[-1*m*C,-1*f*C,-1*v*C],x=V(r,s),E=V(r,P),M=V(s,P),S=V(r,I),D=V(s,I);return V(r,o=E<S&&E<D||M<S&&M<D?P:I)>x||V(s,o)>x?p(K(o),K(r))<=p(K(o),K(s))?[K(r),!0,!1]:[K(s),!1,!0]:[K(o),!1,!1]}(n,a,t),d&&(l=p(t,d))<o&&(i=d,o=l,r=e.indexOf(s))}return 1/0===o?void 0:{coordinate:i,distance:o,lineIndex:r}}(n,s)),!o)return;let a=this.pixelDistance.measure(t,o.coordinate);a<r.minDistance&&a<this.pointerDistance&&(r.featureId=e.id,r.coordinate=[y(o.coordinate[0],this.config.coordinatePrecision),y(o.coordinate[1],this.config.coordinatePrecision)],r.featureCoordinateIndex=o.lineIndex,r.minDistance=a)}),r}}let z={cancel:"Escape",finish:"Enter"},H={start:"crosshair",close:"pointer",dragStart:"grabbing",dragEnd:"crosshair"};class $ extends h{constructor(t){super(t,!0),this.mode="linestring",this.currentCoordinate=0,this.currentId=void 0,this.closingPointId=void 0,this.keyEvents=z,this.snapping=void 0,this.cursors=H,this.mouseMove=!1,this.insertCoordinates=void 0,this.lastCommittedCoordinates=void 0,this.snappedPointId=void 0,this.lastMouseMoveEvent=void 0,this.editable=!1,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedSnapType=void 0,this.editedInsertIndex=void 0,this.editedPointId=void 0,this.coordinateSnapping=void 0,this.insertPoint=void 0,this.lineSnapping=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.updateOptions(t)}updateOptions(t){super.updateOptions(t),null!=t&&t.cursors&&(this.cursors=o({},this.cursors,t.cursors)),null!=t&&t.snapping&&(this.snapping=t.snapping),null===(null==t?void 0:t.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=t&&t.keyEvents&&(this.keyEvents=o({},this.keyEvents,t.keyEvents)),null!=t&&t.insertCoordinates&&(this.insertCoordinates=t.insertCoordinates),t&&t.editable&&(this.editable=t.editable)}updateSnappedCoordinate(t){let e=this.snapCoordinate(t);if(e){if(this.snappedPointId)this.store.updateGeometry([{id:this.snappedPointId,geometry:{type:"Point",coordinates:e}}]);else{let[t]=this.store.create([{geometry:{type:"Point",coordinates:e},properties:{mode:this.mode,[s.SNAPPING_POINT]:!0}}]);this.snappedPointId=t}t.lng=e[0],t.lat=e[1]}else this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0);return e}close(){if(void 0===this.currentId)return;let t=this.store.getGeometryCopy(this.currentId);t.coordinates.pop(),this.updateGeometries([...t.coordinates],void 0,tY.Commit),this.store.updateProperty([{id:this.currentId,property:s.CURRENTLY_DRAWING,value:void 0}]);let e=this.currentId;this.closingPointId&&this.store.delete([this.closingPointId]),this.snappedPointId&&this.store.delete([this.snappedPointId]),this.currentCoordinate=0,this.currentId=void 0,this.closingPointId=void 0,this.snappedPointId=void 0,this.lastCommittedCoordinates=void 0,"drawing"===this.state&&this.setStarted(),this.onFinish(e,{mode:this.mode,action:"draw"})}updateGeometries(t,e,i){if(!this.currentId)return;let o={type:"LineString",coordinates:t};if(this.validate&&!this.validate({type:"Feature",geometry:o},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:i}).valid)return;let r=[{id:this.currentId,geometry:o}];this.closingPointId&&e&&r.push({id:this.closingPointId,geometry:{type:"Point",coordinates:e}}),"commit"===i&&(this.lastCommittedCoordinates=o.coordinates),this.store.updateGeometry(r)}generateInsertCoordinates(t,e){if(!this.insertCoordinates||!this.lastCommittedCoordinates)throw Error("Not able to insert coordinates");if("amount"!==this.insertCoordinates.strategy)throw Error("Strategy does not exist");let i=p(t,e)/(this.insertCoordinates.value+1),o=[];return"globe"===this.projection?o=this.insertPoint.generateInsertionGeodesicCoordinates(t,e,i):"web-mercator"===this.projection&&(o=this.insertPoint.generateInsertionCoordinates(t,e,i)),o}createLine(t){let[e]=this.store.create([{geometry:{type:"LineString",coordinates:[t,t]},properties:{mode:this.mode,[s.CURRENTLY_DRAWING]:!0}}]);this.lastCommittedCoordinates=[t,t],this.currentId=e,this.currentCoordinate++,this.setDrawing()}firstUpdateToLine(t){if(!this.currentId)return;let e=this.store.getGeometryCopy(this.currentId).coordinates,[i]=this.store.create([{geometry:{type:"Point",coordinates:[...t]},properties:{mode:this.mode,[s.CLOSING_POINT]:!0}}]);this.closingPointId=i,this.setCursor(this.cursors.close);let o=[...e,t];this.updateGeometries(o,void 0,tY.Commit),this.currentCoordinate++}updateToLine(t,e){if(!this.currentId)return;let i=this.store.getGeometryCopy(this.currentId).coordinates,[o,r]=this.lastCommittedCoordinates?this.lastCommittedCoordinates[this.lastCommittedCoordinates.length-1]:i[i.length-2],{x:s,y:n}=this.project(o,r);if(b({x:s,y:n},{x:e.x,y:e.y})<this.pointerDistance)return void this.close();this.setCursor(this.cursors.close);let a=[...i,t];this.updateGeometries(a,i[i.length-1],tY.Commit),this.currentCoordinate++}registerBehaviors(t){this.coordinateSnapping=new j(t,new T(t),new N(t)),this.insertPoint=new L(t),this.clickBoundingBox=new N(t),this.pixelDistance=new T(t),this.lineSnapping=new X(t,this.pixelDistance,this.clickBoundingBox),this.coordinateSnapping=new j(t,this.pixelDistance,this.clickBoundingBox)}start(){this.setStarted(),this.setCursor(this.cursors.start)}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onMouseMove(t){this.mouseMove=!0,this.setCursor(this.cursors.start),this.lastMouseMoveEvent=t;let e=this.updateSnappedCoordinate(t)||[t.lng,t.lat];if(void 0===this.currentId||0===this.currentCoordinate)return;let i=this.store.getGeometryCopy(this.currentId).coordinates;if(i.pop(),this.closingPointId){let[e,o]=i[i.length-1],{x:r,y:s}=this.project(e,o);b({x:r,y:s},{x:t.containerX,y:t.containerY})<this.pointerDistance&&this.setCursor(this.cursors.close)}let o=[...i,e];if(this.insertCoordinates&&this.currentId&&this.lastCommittedCoordinates){let t=this.lastCommittedCoordinates[this.lastCommittedCoordinates.length-1];if(!A(t,e)){let i=this.generateInsertCoordinates(t,e);o=[...this.lastCommittedCoordinates.slice(0,-1),...i,e]}}this.updateGeometries(o,void 0,tY.Provisional)}onRightClick(t){let e;if(!this.editable||"started"!==this.state)return;let{featureId:i,featureCoordinateIndex:o}=this.coordinateSnapping.getSnappable(t,t=>this.lineStringFilter(t));if(!i||void 0===o)return;let r=this.store.getGeometryCopy(i);if("LineString"===r.type&&!((e=r.coordinates).length<=2)){if(e.splice(o,1),this.validate&&!this.validate({id:i,type:"Feature",geometry:r,properties:{}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Commit}).valid)return;this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0),this.store.updateGeometry([{id:i,geometry:r}]),this.onFinish(i,{mode:this.mode,action:"edit"})}}onLeftClick(t){this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0);let e=this.snapCoordinate(t)||[t.lng,t.lat];0===this.currentCoordinate?this.createLine(e):1===this.currentCoordinate&&this.currentId?this.firstUpdateToLine(e):this.currentId&&this.updateToLine(e,{x:t.containerX,y:t.containerY})}onClick(t){("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))&&(this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,"right"===t.button?this.onRightClick(t):"left"===t.button&&this.onLeftClick(t))}onKeyDown(){}onKeyUp(t){t.key===this.keyEvents.cancel&&this.cleanUp(),t.key===this.keyEvents.finish&&this.close()}onDragStart(t,e){let i;if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.editable){if("started"===this.state){let e=this.lineSnapping.getSnappable(t,t=>this.lineStringFilter(t));e.coordinate&&(this.editedSnapType="line",this.editedFeatureCoordinateIndex=e.featureCoordinateIndex,this.editedFeatureId=e.featureId,i=e.coordinate);let o=this.coordinateSnapping.getSnappable(t,t=>this.lineStringFilter(t));o.coordinate&&(this.editedSnapType="coordinate",this.editedFeatureCoordinateIndex=o.featureCoordinateIndex,this.editedFeatureId=o.featureId,i=o.coordinate)}if(this.editedFeatureId&&i){if(!this.editedPointId){let[t]=this.store.create([{geometry:{type:"Point",coordinates:i},properties:{mode:this.mode,[s.EDITED]:!0}}]);this.editedPointId=t}this.setCursor(this.cursors.dragStart),e(!1)}}}onDrag(t,e){if(!this.allowPointerEvent(this.pointerEvents.onDrag,t)||void 0===this.editedFeatureId||void 0===this.editedFeatureCoordinateIndex)return;let i=this.store.getGeometryCopy(this.editedFeatureId);"coordinate"===this.editedSnapType||"line"===this.editedSnapType&&void 0!==this.editedInsertIndex?i.coordinates[this.editedFeatureCoordinateIndex]=[t.lng,t.lat]:"line"===this.editedSnapType&&void 0===this.editedInsertIndex&&(this.editedInsertIndex=this.editedFeatureCoordinateIndex+1,i.coordinates.splice(this.editedInsertIndex,0,[t.lng,t.lat]),this.editedFeatureCoordinateIndex++);let o={type:"LineString",coordinates:i.coordinates};this.validate&&!this.validate({type:"Feature",geometry:o,properties:this.store.getPropertiesCopy(this.editedFeatureId)},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Provisional}).valid||(this.snapping&&this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0),this.store.updateGeometry([{id:this.editedFeatureId,geometry:o}]),this.editedPointId&&this.store.updateGeometry([{id:this.editedPointId,geometry:{type:"Point",coordinates:[t.lng,t.lat]}}]),this.store.updateProperty([{id:this.editedFeatureId,property:s.EDITED,value:!0}]))}onDragEnd(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&(this.setCursor(this.cursors.dragEnd),this.editedPointId&&(this.store.delete([this.editedPointId]),this.editedPointId=void 0),this.store.updateProperty([{id:this.editedFeatureId,property:s.EDITED,value:!1}]),this.onFinish(this.editedFeatureId,{mode:this.mode,action:"edit"}),this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0,e(!0))}cleanUp(){let t=this.currentId,e=this.closingPointId,i=this.snappedPointId;this.closingPointId=void 0,this.snappedPointId=void 0,this.currentId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted();try{void 0!==t&&this.store.delete([t]),void 0!==i&&this.store.delete([i]),void 0!==e&&this.store.delete([e])}catch(t){}}styleFeature(t){let e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if("Feature"===t.type&&"LineString"===t.geometry.type&&t.properties.mode===this.mode)return e.lineStringColor=this.getHexColorStylingValue(this.styles.lineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.lineStringWidth,e.lineStringWidth,t),e.zIndex=10,e;if("Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode){let i=t.properties[s.CLOSING_POINT];return e.pointColor=this.getHexColorStylingValue(i?this.styles.closingPointColor:this.styles.snappingPointColor,e.pointColor,t),e.pointWidth=this.getNumericStylingValue(i?this.styles.closingPointWidth:this.styles.snappingPointWidth,e.pointWidth,t),e.pointOutlineColor=this.getHexColorStylingValue(i?this.styles.closingPointOutlineColor:this.styles.snappingPointOutlineColor,"#ffffff",t),e.pointOutlineWidth=this.getNumericStylingValue(i?this.styles.closingPointOutlineWidth:this.styles.snappingPointOutlineWidth,2,t),e.zIndex=50,e}return e}validateFeature(t){return this.validateModeFeature(t,t=>(function(t,e){if("LineString"!==t.geometry.type)return{valid:!1,reason:"Feature is not a LineString"};if(t.geometry.coordinates.length<2)return{valid:!1,reason:"Feature has less than 2 coordinates"};for(let i=0;i<t.geometry.coordinates.length;i++){if(!x(t.geometry.coordinates[i]))return{valid:!1,reason:"Feature has invalid coordinates"};if(!I(t.geometry.coordinates[i],e))return{valid:!1,reason:"Feature has coordinates with excessive precision"}}return{valid:!0}})(t,this.coordinatePrecision))}lineStringFilter(t){return!!("LineString"===t.geometry.type&&t.properties&&t.properties.mode===this.mode)}snapCoordinate(t){var e,i,o;let r;if(null!=(e=this.snapping)&&e.toLine){let e;(e=this.currentId?this.lineSnapping.getSnappableCoordinate(t,this.currentId):this.lineSnapping.getSnappableCoordinateFirstClick(t))&&(r=e)}return null!=(i=this.snapping)&&i.toCoordinate&&(r=this.currentId?this.coordinateSnapping.getSnappableCoordinate(t,this.currentId):this.coordinateSnapping.getSnappableCoordinateFirstClick(t)),null!=(o=this.snapping)&&o.toCustom&&(r=this.snapping.toCustom(t,{currentCoordinate:this.currentCoordinate,currentId:this.currentId,getCurrentGeometrySnapshot:this.currentId?()=>this.store.getGeometryCopy(this.currentId):()=>null,project:this.project,unproject:this.unproject})),r}afterFeatureUpdated(t){this.editedFeatureId===t.id&&this.editedPointId&&(this.store.delete([this.editedPointId]),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedSnapType=void 0),this.snappedPointId&&this.lastMouseMoveEvent&&this.updateSnappedCoordinate(this.lastMouseMoveEvent),this.currentId===t.id&&(this.closingPointId&&(this.store.delete([this.closingPointId]),this.closingPointId=void 0),this.currentCoordinate=0,this.currentId=void 0,"drawing"===this.state&&this.setStarted())}}let q={create:"crosshair",dragStart:"grabbing",dragEnd:"crosshair"};class Z extends h{constructor(t){super(t,!0),this.mode="point",this.cursors=q,this.editable=!1,this.editedFeatureId=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.updateOptions(t)}updateOptions(t){super.updateOptions(t),null!=t&&t.cursors&&(this.cursors=o({},this.cursors,t.cursors)),null!=t&&t.editable&&(this.editable=t.editable)}start(){this.setStarted(),this.setCursor(this.cursors.create)}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onClick(t){"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)}onMouseMove(){}onKeyDown(){}onKeyUp(){}cleanUp(){this.editedFeatureId=void 0}onDragStart(t,e){if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)){if(this.editable){let e=this.getNearestPointFeature(t);this.editedFeatureId=null==e?void 0:e.id}this.editedFeatureId&&(this.setCursor(this.cursors.dragStart),e(!1))}}onDrag(t,e){this.allowPointerEvent(this.pointerEvents.onDrag,t)&&void 0!==this.editedFeatureId&&(this.validate&&!this.validate({type:"Feature",geometry:{type:"Point",coordinates:[t.lng,t.lat]},properties:this.store.getPropertiesCopy(this.editedFeatureId)},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Finish}).valid||(this.store.updateGeometry([{id:this.editedFeatureId,geometry:{type:"Point",coordinates:[t.lng,t.lat]}}]),this.store.updateProperty([{id:this.editedFeatureId,property:s.EDITED,value:!0}])))}onDragEnd(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&(this.onFinish(this.editedFeatureId,{mode:this.mode,action:"edit"}),this.setCursor(this.cursors.dragEnd),this.store.updateProperty([{id:this.editedFeatureId,property:s.EDITED,value:!1}]),this.editedFeatureId=void 0,e(!0))}registerBehaviors(t){this.pixelDistance=new T(t),this.clickBoundingBox=new N(t)}styleFeature(t){let e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if("Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode){let i=!!(t.id&&this.editedFeatureId===t.id);e.pointWidth=this.getNumericStylingValue(i?this.styles.editedPointWidth:this.styles.pointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(i?this.styles.editedPointColor:this.styles.pointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(i?this.styles.editedPointOutlineColor:this.styles.pointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(i?this.styles.editedPointOutlineWidth:this.styles.pointOutlineWidth,2,t),e.zIndex=30}return e}validateFeature(t){return this.validateModeFeature(t,t=>{var e;return e=this.coordinatePrecision,"Point"!==t.geometry.type?{valid:!1,reason:"Feature is not a Point"}:x(t.geometry.coordinates)?I(t.geometry.coordinates,e)?{valid:!0}:{valid:!1,reason:"Feature has coordinates with excessive precision"}:{valid:!1,reason:"Feature has invalid coordinates"}})}onLeftClick(t){let e={type:"Point",coordinates:[t.lng,t.lat]},i={mode:this.mode};if(this.validate&&!this.validate({type:"Feature",geometry:e,properties:i},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Finish}).valid)return;let[o]=this.store.create([{geometry:e,properties:i}]);this.onFinish(o,{mode:this.mode,action:"draw"})}onRightClick(t){if(!this.editable)return;let e=this.getNearestPointFeature(t);e&&this.store.delete([e.id])}getNearestPointFeature(t){let e=this.clickBoundingBox.create(t),i=this.store.search(e),o,r=1/0;for(let e=0;e<i.length;e++){let s=i[e];if("Point"!==s.geometry.type||s.properties.mode!==this.mode)continue;let n=this.pixelDistance.measure(t,s.geometry.coordinates);n>r||n>this.pointerDistance||(r=n,o=s)}return o}afterFeatureUpdated(t){this.editedFeatureId===t.id&&(this.editedFeatureId=void 0,this.setCursor(this.cursors.create))}}class J extends w{constructor(t,e){super(t),this.config=void 0,this.pixelDistance=void 0,this._startEndPoints=[],this.config=t,this.pixelDistance=e}get ids(){return this._startEndPoints.concat()}set ids(t){}create(t,e){if(this.ids.length)throw Error("Opening and closing points already created");if(t.length<=3)throw Error("Requires at least 4 coordinates");this._startEndPoints=this.store.create([{geometry:{type:"Point",coordinates:t[0]},properties:{mode:e,[s.CLOSING_POINT]:!0}},{geometry:{type:"Point",coordinates:t[t.length-2]},properties:{mode:e,[s.CLOSING_POINT]:!0}}])}delete(){this.ids.length&&(this.store.delete(this.ids),this._startEndPoints=[])}update(t){if(2!==this.ids.length)throw Error("No closing points to update");this.store.updateGeometry([{id:this.ids[0],geometry:{type:"Point",coordinates:t[0]}},{id:this.ids[1],geometry:{type:"Point",coordinates:t[t.length-3]}}])}isClosingPoint(t){let e=this.store.getGeometryCopy(this.ids[0]),i=this.store.getGeometryCopy(this.ids[1]),o=this.pixelDistance.measure(t,e.coordinates),r=this.pixelDistance.measure(t,i.coordinates);return{isClosing:o<this.pointerDistance,isPreviousClosing:r<this.pointerDistance}}}class Q extends w{constructor(t){super(t)}createOrUpdate(t){let e,i=this.store.getGeometryCopy(t),o=this.store.getPropertiesCopy(t);if("Polygon"===i.type)e=i.coordinates[0].slice(0,-1);else{if("LineString"!==i.type)return;e=i.coordinates}let r=this.store.getPropertiesCopy(t),s=r.coordinatePointIds;if(s)if(s&&s.every(t=>this.store.has(t))){let i=r.coordinatePointIds,s=i.map(t=>this.store.getGeometryCopy(t).coordinates);if(i.length!==e.length){this.deleteCoordinatePoints(i);let r=this.createPoints(e,o.mode,t);this.setFeatureCoordinatePoints(t,r)}else e.forEach((t,e)=>{t[0]===s[e][0]&&t[1]===s[e][1]||this.store.updateGeometry([{id:i[e],geometry:{type:"Point",coordinates:t}}])})}else{let i=s.filter(t=>this.store.has(t));i.length&&this.deleteCoordinatePoints(i);let r=this.createPoints(e,o.mode,t);this.setFeatureCoordinatePoints(t,r)}else{let i=this.createPoints(e,o.mode,t);this.setFeatureCoordinatePoints(t,i)}}deletePointsByFeatureIds(t){for(let e of t)this.deleteIfPresent(e)}getUpdated(t,e){let i=this.store.getPropertiesCopy(t);if(i.coordinatePointIds)return i.coordinatePointIds.map((t,i)=>({id:t,geometry:o({},this.store.getGeometryCopy(t),{coordinates:e[i]})}))}createPoints(t,e,i){return this.store.create(t.map((t,o)=>({geometry:{type:"Point",coordinates:t},properties:{mode:e,[s.COORDINATE_POINT]:!0,[s.COORDINATE_POINT_FEATURE_ID]:i,index:o}})))}setFeatureCoordinatePoints(t,e){this.store.updateProperty([{id:t,property:s.COORDINATE_POINT_IDS,value:e}])}deleteCoordinatePoints(t){let e=t.filter(t=>this.store.has(t));this.store.delete(e)}deleteIfPresent(t){let e=this.store.getPropertiesCopy(t).coordinatePointIds;e&&(this.deleteCoordinatePoints(e),this.setFeatureCoordinatePoints(t,null))}}let tt={cancel:"Escape",finish:"Enter"},te={start:"crosshair",close:"pointer",dragStart:"grabbing",dragEnd:"crosshair"};class ti extends h{constructor(t){super(t,!0),this.mode="polygon",this.currentCoordinate=0,this.currentId=void 0,this.keyEvents=tt,this.cursors=te,this.mouseMove=!1,this.showCoordinatePoints=!1,this.lastMouseMoveEvent=void 0,this.snapping=void 0,this.snappedPointId=void 0,this.editable=!1,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedSnapType=void 0,this.editedInsertIndex=void 0,this.editedPointId=void 0,this.coordinatePoints=void 0,this.lineSnapping=void 0,this.coordinateSnapping=void 0,this.pixelDistance=void 0,this.closingPoints=void 0,this.clickBoundingBox=void 0,this.updateOptions(t)}updateOptions(t){if(super.updateOptions(t),null!=t&&t.cursors&&(this.cursors=o({},this.cursors,t.cursors)),null===(null==t?void 0:t.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=t&&t.keyEvents&&(this.keyEvents=o({},this.keyEvents,t.keyEvents)),null!=t&&t.snapping&&(this.snapping=t.snapping),void 0!==(null==t?void 0:t.editable)&&(this.editable=t.editable),void 0!==(null==t?void 0:t.pointerEvents)&&(this.pointerEvents=t.pointerEvents),void 0!==(null==t?void 0:t.showCoordinatePoints)){if(this.showCoordinatePoints=t.showCoordinatePoints,this.coordinatePoints&&!0===t.showCoordinatePoints)this.store.copyAllWhere(t=>t.mode===this.mode).map(t=>t.id).forEach(t=>{this.coordinatePoints.createOrUpdate(t)});else if(this.coordinatePoints&&!1===this.showCoordinatePoints){let t=this.store.copyAllWhere(t=>t.mode===this.mode&&!!t[s.COORDINATE_POINT_IDS]);this.coordinatePoints.deletePointsByFeatureIds(t.map(t=>t.id))}}}close(){if(void 0===this.currentId)return;let t=this.store.getGeometryCopy(this.currentId).coordinates[0];if(t.length<5||!this.updatePolygonGeometry([...t.slice(0,-2),t[0]],tY.Finish))return;let e=this.currentId;if(this.currentId){let t=O(this.store.getGeometryCopy(this.currentId));t&&(this.store.updateGeometry([{id:this.currentId,geometry:t}]),this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(this.currentId)),this.store.updateProperty([{id:this.currentId,property:s.CURRENTLY_DRAWING,value:void 0},{id:this.currentId,property:s.COMMITTED_COORDINATE_COUNT,value:void 0},{id:this.currentId,property:s.PROVISIONAL_COORDINATE_COUNT,value:void 0}])}this.snappedPointId&&this.store.delete([this.snappedPointId]),this.currentCoordinate=0,this.currentId=void 0,this.snappedPointId=void 0,this.closingPoints.delete(),"drawing"===this.state&&this.setStarted(),this.onFinish(e,{mode:this.mode,action:"draw"})}registerBehaviors(t){this.clickBoundingBox=new N(t),this.pixelDistance=new T(t),this.lineSnapping=new X(t,this.pixelDistance,this.clickBoundingBox),this.coordinateSnapping=new j(t,this.pixelDistance,this.clickBoundingBox),this.closingPoints=new J(t,this.pixelDistance),this.coordinatePoints=new Q(t)}start(){this.setStarted(),this.setCursor(this.cursors.start)}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}updateSnappedCoordinate(t){let e=this.snapCoordinate(t);if(e){if(this.snappedPointId)this.store.updateGeometry([{id:this.snappedPointId,geometry:{type:"Point",coordinates:e}}]);else{let[t]=this.store.create([{geometry:{type:"Point",coordinates:e},properties:{mode:this.mode,[s.SNAPPING_POINT]:!0}}]);this.snappedPointId=t}t.lng=e[0],t.lat=e[1]}else this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0)}onMouseMove(t){let e;if(this.mouseMove=!0,this.setCursor(this.cursors.start),this.lastMouseMoveEvent=t,this.updateSnappedCoordinate(t),void 0===this.currentId||0===this.currentCoordinate)return;let i=this.store.getGeometryCopy(this.currentId).coordinates[0];if(1===this.currentCoordinate){let o=Math.max(1e-6,1/Math.pow(10,this.coordinatePrecision-1));e=[i[0],[t.lng,t.lat],[t.lng,t.lat-o],i[0]]}else if(2===this.currentCoordinate)e=[i[0],i[1],[t.lng,t.lat],i[0]];else{let{isClosing:o,isPreviousClosing:r}=this.closingPoints.isClosingPoint(t);r||o?(this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0),this.setCursor(this.cursors.close),e=[...i.slice(0,-2),i[0],i[0]]):e=[...i.slice(0,-2),[t.lng,t.lat],i[0]]}this.store.updateProperty([{id:this.currentId,property:s.PROVISIONAL_COORDINATE_COUNT,value:this.currentCoordinate+1}]),this.updatePolygonGeometry(e,tY.Provisional)}updatePolygonGeometry(t,e){if(!this.currentId)return!1;let i={type:"Polygon",coordinates:[t]};return!(this.validate&&!this.validate({type:"Feature",geometry:i},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:e}).valid||(this.store.updateGeometry([{id:this.currentId,geometry:i}]),this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(this.currentId),0))}snapCoordinate(t){var e,i,o;let r;if(null!=(e=this.snapping)&&e.toLine){let e;(e=this.currentId?this.lineSnapping.getSnappableCoordinate(t,this.currentId):this.lineSnapping.getSnappableCoordinateFirstClick(t))&&(r=e)}if(null!=(i=this.snapping)&&i.toCoordinate){let e;(e=this.currentId?this.coordinateSnapping.getSnappableCoordinate(t,this.currentId):this.coordinateSnapping.getSnappableCoordinateFirstClick(t))&&(r=e)}return null!=(o=this.snapping)&&o.toCustom&&(r=this.snapping.toCustom(t,{currentCoordinate:this.currentCoordinate,currentId:this.currentId,getCurrentGeometrySnapshot:this.currentId?()=>this.store.getGeometryCopy(this.currentId):()=>null,project:this.project,unproject:this.unproject})),r}polygonFilter(t){return!!("Polygon"===t.geometry.type&&t.properties&&t.properties.mode===this.mode)}onRightClick(t){let e;if(!this.editable||"started"!==this.state)return;let{featureId:i,featureCoordinateIndex:o}=this.coordinateSnapping.getSnappable(t,t=>this.polygonFilter(t));if(!i||void 0===o)return;let r=this.store.getGeometryCopy(i);"Polygon"===r.type&&((e=r.coordinates[0]).length<=4||("Polygon"!==r.type||0!==o&&o!==e.length-1?e.splice(o,1):(e.shift(),e.pop(),e.push([e[0][0],e[0][1]])),(!this.validate||this.validate({id:i,type:"Feature",geometry:r,properties:{}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Commit}).valid)&&(this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0),this.store.updateGeometry([{id:i,geometry:r}]),this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(i),this.onFinish(i,{mode:this.mode,action:"edit"}))))}onLeftClick(t){if(this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0),0===this.currentCoordinate){let e=this.snapCoordinate(t);e&&(t.lng=e[0],t.lat=e[1]);let[i]=this.store.create([{geometry:{type:"Polygon",coordinates:[[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]]]},properties:{mode:this.mode,[s.CURRENTLY_DRAWING]:!0,[s.COMMITTED_COORDINATE_COUNT]:this.currentCoordinate+1,[s.PROVISIONAL_COORDINATE_COUNT]:this.currentCoordinate+1}}]);this.currentId=i,this.currentCoordinate++,this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(i),this.setDrawing()}else if(1===this.currentCoordinate&&this.currentId){let e=this.snapCoordinate(t);e&&(t.lng=e[0],t.lat=e[1]);let i=this.store.getGeometryCopy(this.currentId);if(A([t.lng,t.lat],i.coordinates[0][0])||!this.updatePolygonGeometry([i.coordinates[0][0],[t.lng,t.lat],[t.lng,t.lat],i.coordinates[0][0]],tY.Commit))return;this.store.updateProperty([{id:this.currentId,property:s.COMMITTED_COORDINATE_COUNT,value:this.currentCoordinate+1}]),this.currentCoordinate++}else if(2===this.currentCoordinate&&this.currentId){let e=this.snapCoordinate(t);e&&(t.lng=e[0],t.lat=e[1]);let i=this.store.getGeometryCopy(this.currentId).coordinates[0];if(A([t.lng,t.lat],i[1])||!this.updatePolygonGeometry([i[0],i[1],[t.lng,t.lat],[t.lng,t.lat],i[0]],tY.Commit))return;2===this.currentCoordinate&&this.closingPoints.create(i,"polygon"),this.store.updateProperty([{id:this.currentId,property:s.COMMITTED_COORDINATE_COUNT,value:this.currentCoordinate+1}]),this.currentCoordinate++}else if(this.currentId){let e=this.store.getGeometryCopy(this.currentId).coordinates[0],{isClosing:i,isPreviousClosing:o}=this.closingPoints.isClosingPoint(t);if(o||i)this.close();else{let i=this.snapCoordinate(t);if(i&&(t.lng=i[0],t.lat=i[1]),A([t.lng,t.lat],e[this.currentCoordinate-1]))return;let o=function(t=[[[0,0],[0,1],[1,1],[1,0],[0,0]]]){return{type:"Feature",geometry:{type:"Polygon",coordinates:t},properties:{}}}([[...e.slice(0,-1),[t.lng,t.lat],e[0]]]);if(!this.updatePolygonGeometry(o.geometry.coordinates[0],tY.Commit))return;this.store.updateProperty([{id:this.currentId,property:s.COMMITTED_COORDINATE_COUNT,value:this.currentCoordinate+1}]),this.currentCoordinate++,this.closingPoints.ids.length&&this.closingPoints.update(o.geometry.coordinates[0])}}}onClick(t){this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)}onKeyUp(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()}onKeyDown(){}onDragStart(t,e){let i;if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.editable){if("started"===this.state){let e=this.lineSnapping.getSnappable(t,t=>this.polygonFilter(t));e.coordinate&&(this.editedSnapType="line",this.editedFeatureCoordinateIndex=e.featureCoordinateIndex,this.editedFeatureId=e.featureId,i=e.coordinate);let o=this.coordinateSnapping.getSnappable(t,t=>this.polygonFilter(t));o.coordinate&&(this.editedSnapType="coordinate",this.editedFeatureCoordinateIndex=o.featureCoordinateIndex,this.editedFeatureId=o.featureId,i=o.coordinate)}if(this.editedFeatureId&&i){if(!this.editedPointId){let[t]=this.store.create([{geometry:{type:"Point",coordinates:i},properties:{mode:this.mode,[s.EDITED]:!0}}]);this.editedPointId=t}this.setCursor(this.cursors.dragStart),e(!1)}}}onDrag(t,e){if(!this.allowPointerEvent(this.pointerEvents.onDrag,t)||void 0===this.editedFeatureId||void 0===this.editedFeatureCoordinateIndex)return;let i=this.store.getGeometryCopy(this.editedFeatureId),o=i.coordinates[0];"coordinate"===this.editedSnapType||"line"===this.editedSnapType&&void 0!==this.editedInsertIndex?0===this.editedFeatureCoordinateIndex||this.editedFeatureCoordinateIndex===i.coordinates[0].length-1?(o[0]=[t.lng,t.lat],o[o.length-1]=[t.lng,t.lat]):o[this.editedFeatureCoordinateIndex]=[t.lng,t.lat]:"line"===this.editedSnapType&&void 0===this.editedInsertIndex&&(this.editedInsertIndex=this.editedFeatureCoordinateIndex+1,i.coordinates[0].splice(this.editedInsertIndex,0,[t.lng,t.lat]),this.editedFeatureCoordinateIndex++);let r={type:"Polygon",coordinates:i.coordinates};this.validate&&!this.validate({type:"Feature",geometry:r,properties:this.store.getPropertiesCopy(this.editedFeatureId)},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Provisional}).valid||(this.snapping&&this.snappedPointId&&(this.store.delete([this.snappedPointId]),this.snappedPointId=void 0),this.store.updateGeometry([{id:this.editedFeatureId,geometry:r}]),this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(this.editedFeatureId),this.editedPointId&&this.store.updateGeometry([{id:this.editedPointId,geometry:{type:"Point",coordinates:[t.lng,t.lat]}}]),this.store.updateProperty([{id:this.editedFeatureId,property:s.EDITED,value:!0}]))}onDragEnd(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&(this.setCursor(this.cursors.dragEnd),this.editedPointId&&(this.store.delete([this.editedPointId]),this.editedPointId=void 0),this.store.updateProperty([{id:this.editedFeatureId,property:s.EDITED,value:!1}]),this.onFinish(this.editedFeatureId,{mode:this.mode,action:"edit"}),this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0,e(!0))}cleanUp(){let t=this.currentId,e=this.snappedPointId,i=this.editedPointId;this.currentId=void 0,this.snappedPointId=void 0,this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted();try{t&&this.coordinatePoints.deletePointsByFeatureIds([t]),void 0!==t&&this.store.delete([t]),void 0!==i&&this.store.delete([i]),void 0!==e&&this.store.delete([e]),this.closingPoints.ids.length&&this.closingPoints.delete()}catch(t){}}styleFeature(t){let e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if(t.properties.mode===this.mode){if("Polygon"===t.geometry.type)return e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=10,e;if("Point"===t.geometry.type){let i=t.properties[s.EDITED],o=t.properties[s.COORDINATE_POINT],r=i?"editedPoint":t.properties[s.CLOSING_POINT]?"closingPoint":t.properties[s.SNAPPING_POINT]?"snappingPoint":o?"coordinatePoint":void 0;if(!r)return e;let n={editedPoint:{width:this.styles.editedPointOutlineWidth,color:this.styles.editedPointColor,outlineColor:this.styles.editedPointOutlineColor,outlineWidth:this.styles.editedPointOutlineWidth},closingPoint:{width:this.styles.closingPointWidth,color:this.styles.closingPointColor,outlineColor:this.styles.closingPointOutlineColor,outlineWidth:this.styles.closingPointOutlineWidth},snappingPoint:{width:this.styles.snappingPointWidth,color:this.styles.snappingPointColor,outlineColor:this.styles.snappingPointOutlineColor,outlineWidth:this.styles.snappingPointOutlineWidth},coordinatePoint:{width:this.styles.coordinatePointWidth,color:this.styles.coordinatePointColor,outlineColor:this.styles.coordinatePointOutlineColor,outlineWidth:this.styles.coordinatePointOutlineWidth}};return e.pointWidth=this.getNumericStylingValue(n[r].width,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(n[r].color,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(n[r].outlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(n[r].outlineWidth,2,t),e.zIndex=i?40:o?20:30,e}}return e}afterFeatureAdded(t){this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(t.id)}afterFeatureUpdated(t){this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate(t.id),this.editedFeatureId===t.id&&this.editedPointId&&(this.store.delete([this.editedPointId]),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedSnapType=void 0),this.snappedPointId&&this.lastMouseMoveEvent&&this.updateSnappedCoordinate(this.lastMouseMoveEvent),this.currentId===t.id&&(this.currentCoordinate=0,this.currentId=void 0,this.closingPoints.delete(),"drawing"===this.state&&this.setStarted())}validateFeature(t){return this.validateModeFeature(t,t=>M(t,this.coordinatePrecision))}}let to={cancel:"Escape",finish:"Enter"},tr={start:"crosshair"};class ts extends h{constructor(t){super(t,!0),this.mode="rectangle",this.center=void 0,this.clickCount=0,this.currentRectangleId=void 0,this.keyEvents=to,this.cursors=tr,this.updateOptions(t)}updateOptions(t){super.updateOptions(t),null!=t&&t.cursors&&(this.cursors=o({},this.cursors,t.cursors)),null===(null==t?void 0:t.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=t&&t.keyEvents&&(this.keyEvents=o({},this.keyEvents,t.keyEvents))}updateRectangle(t,e){if(1===this.clickCount&&this.center&&this.currentRectangleId){let i=this.store.getGeometryCopy(this.currentRectangleId).coordinates[0][0],o={type:"Polygon",coordinates:[[i,[t.lng,i[1]],[t.lng,t.lat],[i[0],t.lat],i]]};(!this.validate||this.validate({id:this.currentRectangleId,geometry:o},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:e}).valid)&&this.store.updateGeometry([{id:this.currentRectangleId,geometry:o}])}}close(){let t=this.currentRectangleId;if(t){let e=O(this.store.getGeometryCopy(t));e&&this.store.updateGeometry([{id:t,geometry:e}]),this.store.updateProperty([{id:t,property:s.CURRENTLY_DRAWING,value:void 0}])}this.center=void 0,this.currentRectangleId=void 0,this.clickCount=0,"drawing"===this.state&&this.setStarted(),void 0!==t&&this.onFinish(t,{mode:this.mode,action:"draw"})}start(){this.setStarted(),this.setCursor(this.cursors.start)}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onClick(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))if(0===this.clickCount){this.center=[t.lng,t.lat];let[e]=this.store.create([{geometry:{type:"Polygon",coordinates:[[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]]]},properties:{mode:this.mode,[s.CURRENTLY_DRAWING]:!0}}]);this.currentRectangleId=e,this.clickCount++,this.setDrawing()}else this.updateRectangle(t,tY.Finish),this.close()}onMouseMove(t){this.updateRectangle(t,tY.Provisional)}onKeyDown(){}onKeyUp(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()}onDragStart(){}onDrag(){}onDragEnd(){}cleanUp(){let t=this.currentRectangleId;this.center=void 0,this.currentRectangleId=void 0,this.clickCount=0,"drawing"===this.state&&this.setStarted(),void 0!==t&&this.store.delete([t])}styleFeature(t){let e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"Polygon"===t.geometry.type&&t.properties.mode===this.mode&&(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=10),e}validateFeature(t){return this.validateModeFeature(t,t=>S(t,this.coordinatePrecision))}afterFeatureUpdated(t){this.currentRectangleId===t.id&&(this.center=void 0,this.currentRectangleId=void 0,this.clickCount=0,"drawing"===this.state&&this.setStarted())}}function tn(t,e){let i=u(t[1]),o=u(e[1]),r=u(e[0]-t[0]);r>Math.PI&&(r-=2*Math.PI),r<-Math.PI&&(r+=2*Math.PI);let s=(g(Math.atan2(r,Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(i/2+Math.PI/4))))+360)%360;return s>180?-(360-s):s}function ta(t,e,i){let o=e;e<0&&(o=-Math.abs(o));let r=o/6371008.8,s=t[0]*Math.PI/180,n=u(t[1]),a=u(i),d=r*Math.cos(a),l=n+d;Math.abs(l)>Math.PI/2&&(l=l>0?Math.PI-l:-Math.PI-l);let h=Math.log(Math.tan(l/2+Math.PI/4)/Math.tan(n/2+Math.PI/4)),c=[(180*(s+r*Math.sin(a)/(Math.abs(h)>1e-11?d/h:Math.cos(n)))/Math.PI+540)%360-180,180*l/Math.PI];return c[0]+=c[0]-t[0]>180?-360:360*(t[0]-c[0]>180),c}function td({featureCoords:t,precision:e,unproject:i,project:o,projection:r}){let s=[];for(let n=0;n<t.length-1;n++){let a;if("web-mercator"===r)a=function(t,e,i,o,r){let s=o(t[0],t[1]),n=o(e[0],e[1]),{lng:a,lat:d}=r((s.x+n.x)/2,(s.y+n.y)/2);return[y(a,i),y(d,i)]}(t[n],t[n+1],e,o,i);else{if("globe"!==r)throw Error("Invalid projection");a=function(t,e,i){let o=ta(t,1e3*p(t,e)/2,tn(t,e));return[y(o[0],i),y(o[1],i)]}(t[n],t[n+1],e)}s.push(a)}return s}class tl extends w{constructor(t,e,i){super(t),this.config=void 0,this.selectionPointBehavior=void 0,this.coordinatePointBehavior=void 0,this._midPoints=[],this.config=t,this.selectionPointBehavior=e,this.coordinatePointBehavior=i}get ids(){return this._midPoints.concat()}set ids(t){}insert(t,e,i){let o=this.store.getGeometryCopy(e),{midPointFeatureId:r,midPointSegment:n}=this.store.getPropertiesCopy(e),a=this.store.getGeometryCopy(r),d="Polygon"===a.type?a.coordinates[0]:a.coordinates;d.splice(n+1,0,o.coordinates),a.coordinates="Polygon"===a.type?[d]:d,this.store.updateGeometry([{id:r,geometry:a}]),this.store.getPropertiesCopy(t)[s.COORDINATE_POINT_IDS]&&this.coordinatePointBehavior.createOrUpdate(t),this.store.delete([...this._midPoints,...this.selectionPointBehavior.ids]),this.create(d,r,i),this.selectionPointBehavior.create(d,a.type,r)}create(t,e,i){var o,s;if(!this.store.has(e))throw Error("Store does not have feature with this id");this._midPoints=this.store.create((o=t=>({mode:this.mode,[r.MID_POINT]:!0,midPointSegment:t,midPointFeatureId:e}),s=this.config.project,td({featureCoords:t,precision:i,project:s,unproject:this.config.unproject,projection:this.projection}).map((t,e)=>({geometry:{type:"Point",coordinates:t},properties:o(e)}))))}delete(){this._midPoints.length&&(this.store.delete(this._midPoints),this._midPoints=[])}getUpdated(t){if(0!==this._midPoints.length)return td({featureCoords:t,precision:this.coordinatePrecision,project:this.config.project,unproject:this.config.unproject,projection:this.config.projection}).map((t,e)=>({id:this._midPoints[e],geometry:{type:"Point",coordinates:t}}))}}class th extends w{constructor(t){super(t),this._selectionPoints=[]}get ids(){return this._selectionPoints.concat()}set ids(t){}create(t,e,i){this._selectionPoints=this.store.create(function(t,e,i){let o=[],r="Polygon"===e?t.length-1:t.length;for(let e=0;e<r;e++)o.push({geometry:{type:"Point",coordinates:t[e]},properties:i(e)});return o}(t,e,t=>({mode:this.mode,index:t,[r.SELECTION_POINT]:!0,[r.SELECTION_POINT_FEATURE_ID]:i})))}delete(){this.ids.length&&(this.store.delete(this.ids),this._selectionPoints=[])}getUpdated(t){if(0!==this._selectionPoints.length)return this._selectionPoints.map((e,i)=>({id:e,geometry:{type:"Point",coordinates:t[i]}}))}getOneUpdated(t,e){if(void 0!==this._selectionPoints[t])return{id:this._selectionPoints[t],geometry:{type:"Point",coordinates:e}}}}function tc(t,e){var i,o;let r=!1;for(let s=0,n=e.length;s<n;s++){let n=e[s];for(let e=0,s=n.length,a=s-1;e<s;a=e++)(i=n[e])[1]>t[1]!=(o=n[a])[1]>t[1]&&t[0]<(o[0]-i[0])*(t[1]-i[1])/(o[1]-i[1])+i[0]&&(r=!r)}return r}let tp=(t,e,i)=>{let o=(t,e)=>(t=>t*t)(t.x-e.x)+(t=>t*t)(t.y-e.y);return Math.sqrt(((t,e,i)=>{let r=o(e,i);if(0===r)return o(t,e);let s=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/r;return s=Math.max(0,Math.min(1,s)),o(t,{x:e.x+s*(i.x-e.x),y:e.y+s*(i.y-e.y)})})(t,e,i))};class tu extends w{constructor(t,e,i){super(t),this.config=void 0,this.createClickBoundingBox=void 0,this.pixelDistance=void 0,this.config=t,this.createClickBoundingBox=e,this.pixelDistance=i}find(t,e){let i,o,s,n,a=1/0,d=1/0,l=1/0,h=this.createClickBoundingBox.create(t),c=this.store.search(h);for(let h=0;h<c.length;h++){let p=c[h],u=p.geometry;if("Point"===u.type){if(p.properties.selectionPoint||p.properties.coordinatePoint||!e&&p.properties[r.MID_POINT])continue;let o=this.pixelDistance.measure(t,u.coordinates);p.properties[r.MID_POINT]&&o<this.pointerDistance&&o<l?(l=o,s=p):!p.properties[r.MID_POINT]&&o<this.pointerDistance&&o<a&&(a=o,i=p)}else if("LineString"===u.type){if(i)continue;for(let e=0;e<u.coordinates.length-1;e++){let i=u.coordinates[e],r=u.coordinates[e+1],s=tp({x:t.containerX,y:t.containerY},this.project(i[0],i[1]),this.project(r[0],r[1]));s<this.pointerDistance&&s<d&&(d=s,o=p)}}else if("Polygon"===u.type){if(i||o)continue;tc([t.lng,t.lat],u.coordinates)&&(n=p)}}return{clickedFeature:i||o||n,clickedMidPoint:s}}}class tg extends w{constructor(t,e,i,o,r){super(t),this.config=void 0,this.featuresAtCursorEvent=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.draggedFeatureId=null,this.dragPosition=void 0,this.config=t,this.featuresAtCursorEvent=e,this.selectionPoints=i,this.midPoints=o,this.coordinatePoints=r}startDragging(t,e){this.draggedFeatureId=e,this.dragPosition=[t.lng,t.lat]}stopDragging(){this.draggedFeatureId=null,this.dragPosition=void 0}isDragging(){return null!==this.draggedFeatureId}canDrag(t,e){let{clickedFeature:i}=this.featuresAtCursorEvent.find(t,!0);return!(!i||i.id!==e)}drag(t,e){if(!this.draggedFeatureId)return;let i=this.store.getGeometryCopy(this.draggedFeatureId),o=[t.lng,t.lat];if("Polygon"===i.type||"LineString"===i.type){let r,s;if(s="Polygon"===i.type?(r=i.coordinates[0]).length-1:(r=i.coordinates).length,!this.dragPosition)return!1;for(let t=0;t<s;t++){let e,i,s=r[t];if("web-mercator"===this.config.projection){let t=m(this.dragPosition[0],this.dragPosition[1]),r=m(o[0],o[1]),n=m(s[0],s[1]),a={x:t.x-r.x,y:t.y-r.y},{lng:d,lat:l}=f(n.x-a.x,n.y-a.y);e=d,i=l}else{let t=[this.dragPosition[0]-o[0],this.dragPosition[1]-o[1]];e=s[0]-t[0],i=s[1]-t[1]}if(e=y(e,this.config.coordinatePrecision),i=y(i,this.config.coordinatePrecision),e>180||e<-180||i>90||i<-90)return!1;r[t]=[e,i]}"Polygon"===i.type&&(r[r.length-1]=[r[0][0],r[0][1]]);let n=this.selectionPoints.getUpdated(r)||[],a=this.midPoints.getUpdated(r)||[],d=this.coordinatePoints.getUpdated(this.draggedFeatureId,r)||[];if(e&&!e({type:"Feature",id:this.draggedFeatureId,geometry:i,properties:{}},{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:tY.Provisional}).valid)return!1;this.store.updateGeometry([{id:this.draggedFeatureId,geometry:i},...n,...a,...d]),this.dragPosition=[t.lng,t.lat]}else"Point"===i.type&&(this.store.updateGeometry([{id:this.draggedFeatureId,geometry:{type:"Point",coordinates:o}}]),this.dragPosition=[t.lng,t.lat])}}class ty extends w{constructor(t,e,i,o,r,s,n){super(t),this.config=void 0,this.pixelDistance=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.coordinateSnapping=void 0,this.lineSnapping=void 0,this.draggedCoordinate={id:null,index:-1},this.config=t,this.pixelDistance=e,this.selectionPoints=i,this.midPoints=o,this.coordinatePoints=r,this.coordinateSnapping=s,this.lineSnapping=n}getClosestCoordinate(t,e){let i,o={dist:1/0,index:-1,isFirstOrLastPolygonCoord:!1};if("LineString"===e.type)i=e.coordinates;else{if("Polygon"!==e.type)return o;i=e.coordinates[0]}for(let r=0;r<i.length;r++){let s=this.pixelDistance.measure(t,i[r]);if(s<this.pointerDistance&&s<o.dist){let t="Polygon"===e.type&&(r===i.length-1||0===r);o.dist=s,o.index=t?0:r,o.isFirstOrLastPolygonCoord=t}}return o}getDraggableIndex(t,e){let i=this.store.getGeometryCopy(e),o=this.getClosestCoordinate(t,i);return -1===o.index?-1:o.index}snapCoordinate(t,e,i){let o=[t.lng,t.lat],r=t=>!!(t.properties&&t.properties.mode===i.properties.mode&&t.id!==this.draggedCoordinate.id);if(null!=e&&e.toLine){let e;(e=this.lineSnapping.getSnappable(t,r).coordinate)&&(o=e)}if(e.toCoordinate){let e;(e=this.coordinateSnapping.getSnappable(t,r).coordinate)&&(o=e)}if(null!=e&&e.toCustom){let r;(r=e.toCustom(t,{currentCoordinate:this.draggedCoordinate.index,currentId:i.id,getCurrentGeometrySnapshot:i.id?()=>this.store.getGeometryCopy(i.id):()=>null,project:this.project,unproject:this.unproject}))&&(o=r)}return o}drag(t,e,i,o){let r=this.draggedCoordinate.id;if(null===r)return!1;let s=this.draggedCoordinate.index,n=this.store.getGeometryCopy(r),a=this.store.getPropertiesCopy(r),d="LineString"===n.type?n.coordinates:n.coordinates[0],l="Polygon"===n.type&&(s===d.length-1||0===s),h={type:"Feature",id:r,geometry:n,properties:a},c=this.snapCoordinate(t,o,h);if(t.lng>180||t.lng<-180||t.lat>90||t.lat<-90)return!1;if(l){let t=d.length-1;d[0]=c,d[t]=c}else d[s]=c;let p=this.selectionPoints.getOneUpdated(s,c),u=this.midPoints.getUpdated(d)||[],g=this.coordinatePoints.getUpdated(r,d)||[];return!("Point"!==n.type&&!e&&C({type:"Feature",geometry:n,properties:{}})||i&&!i(h,{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:tY.Provisional}).valid||(this.store.updateGeometry([{id:r,geometry:n},...p?[p]:[],...u,...g]),0))}isDragging(){return null!==this.draggedCoordinate.id}startDragging(t,e){this.draggedCoordinate={id:t,index:e}}stopDragging(){this.draggedCoordinate={id:null,index:-1}}}function tm(t){let e=0,i=0,o=0;return("Polygon"===t.geometry.type?t.geometry.coordinates[0].slice(0,-1):t.geometry.coordinates).forEach(t=>{e+=t[0],i+=t[1],o++},!0),[e/o,i/o]}let tf=(t,e)=>{if(0===e||360===e||-360===e)return t;let i=.017453292519943295*e,o=("Polygon"===t.geometry.type?t.geometry.coordinates[0]:t.geometry.coordinates).map(([t,e])=>m(t,e)),r=o.reduce((t,e)=>({x:t.x+e.x,y:t.y+e.y}),{x:0,y:0});r.x/=o.length,r.y/=o.length;let s=o.map(t=>({x:r.x+(t.x-r.x)*Math.cos(i)-(t.y-r.y)*Math.sin(i),y:r.y+(t.x-r.x)*Math.sin(i)+(t.y-r.y)*Math.cos(i)})).map(({x:t,y:e})=>[f(t,e).lng,f(t,e).lat]);return"Polygon"===t.geometry.type?t.geometry.coordinates[0]=s:t.geometry.coordinates=s,t};function tv(t){let e=("Polygon"===t.geometry.type?t.geometry.coordinates[0]:t.geometry.coordinates).map(t=>{let{x:e,y:i}=m(t[0],t[1]);return[e,i]});return"Polygon"===t.geometry.type?function(t){let e=0,i=0,o=0,r=t.length;for(let s=0;s<r-1;s++){let[r,n]=t[s],[a,d]=t[s+1],l=r*d-a*n;e+=l,i+=(r+a)*l,o+=(n+d)*l}return e/=2,{x:i/=6*e,y:o/=6*e}}(e):function(t){let e=t.length,i=0,o=0;for(let r=0;r<e;r++){let[e,s]=t[r];i+=e,o+=s}return{x:i/e,y:o/e}}(e)}class tC extends w{constructor(t,e,i,o){super(t),this.config=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.lastBearing=void 0,this.selectedGeometry=void 0,this.selectedGeometryCentroid=void 0,this.selectedGeometryWebMercatorCentroid=void 0,this.config=t,this.selectionPoints=e,this.midPoints=i,this.coordinatePoints=o}reset(){this.lastBearing=void 0,this.selectedGeometry=void 0,this.selectedGeometryWebMercatorCentroid=void 0,this.selectedGeometryCentroid=void 0}rotate(t,e,i){let o;this.selectedGeometry||(this.selectedGeometry=this.store.getGeometryCopy(e));let r=this.selectedGeometry;if("Polygon"!==r.type&&"LineString"!==r.type)return;let s=[t.lng,t.lat],n={type:"Feature",geometry:r,properties:{}};if("web-mercator"===this.config.projection){this.selectedGeometryWebMercatorCentroid||(this.selectedGeometryWebMercatorCentroid=tv(n));let e=m(t.lng,t.lat);if(0===(o=function({x:t,y:e},{x:i,y:o}){let r=i-t,s=o-e;if(0===r&&0===s)return 0;let n=Math.atan2(s,r);return(n*=180/Math.PI)>180?n-=360:n<-180&&(n+=360),n}(this.selectedGeometryWebMercatorCentroid,e)))return;if(!this.lastBearing)return void(this.lastBearing=o);tf(n,-(this.lastBearing-o))}else{if("globe"!==this.config.projection)throw Error("Unsupported projection");if(this.selectedGeometryCentroid||(this.selectedGeometryCentroid=tm({type:"Feature",geometry:r,properties:{}})),o=tn(this.selectedGeometryCentroid,s),!this.lastBearing)return void(this.lastBearing=o+180);!function(t,e){if(0===e||360===e||-360===e)return;let i=tm(t);("Polygon"===t.geometry.type?t.geometry.coordinates[0]:t.geometry.coordinates).forEach(t=>{let o=tn(i,t)+e,r=function(t,e){t[0]+=t[0]-e[0]>180?-360:360*(e[0]-t[0]>180);let i=e[1]*Math.PI/180,o=t[1]*Math.PI/180,r=o-i,s=Math.abs(t[0]-e[0])*Math.PI/180;s>Math.PI&&(s-=2*Math.PI);let n=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(i/2+Math.PI/4)),a=Math.abs(n)>1e-11?r/n:Math.cos(i);return 6371008.8*Math.sqrt(r*r+a*a*s*s)}(i,t),s=ta(i,r,o);t[0]=s[0],t[1]=s[1]})}(n,-(this.lastBearing-(o+180)))}let a="Polygon"===r.type?r.coordinates[0]:r.coordinates;a.forEach(t=>{t[0]=y(t[0],this.coordinatePrecision),t[1]=y(t[1],this.coordinatePrecision)});let d=this.midPoints.getUpdated(a)||[],l=this.selectionPoints.getUpdated(a)||[],h=this.coordinatePoints.getUpdated(e,a)||[];if(i&&!i({id:e,type:"Feature",geometry:r,properties:{}},{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:tY.Provisional}))return!1;this.store.updateGeometry([{id:e,geometry:r},...l,...d,...h]),"web-mercator"===this.projection?this.lastBearing=o:"globe"===this.projection&&(this.lastBearing=o+180)}}class tP extends w{constructor(t,e){super(t),this.config=void 0,this.dragCoordinateResizeBehavior=void 0,this.config=t,this.dragCoordinateResizeBehavior=e}scale(t,e,i){if(!this.dragCoordinateResizeBehavior.isDragging()){let i=this.dragCoordinateResizeBehavior.getDraggableIndex(t,e);this.dragCoordinateResizeBehavior.startDragging(e,i)}this.dragCoordinateResizeBehavior.drag(t,"center-fixed",i)}reset(){this.dragCoordinateResizeBehavior.stopDragging()}}function tI({coordinates:t,originX:e,originY:i,xScale:o,yScale:r}){1===o&&1===r||t.forEach(t=>{let{x:s,y:n}=m(t[0],t[1]),{lng:a,lat:d}=f(e+(s-e)*o,i+(n-i)*r);t[0]=a,t[1]=d})}class tx extends w{constructor(t,e,i,o,r){super(t),this.config=void 0,this.pixelDistance=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.minimumScale=1e-4,this.draggedCoordinate={id:null,index:-1},this.boundingBoxMaps={opposite:{0:4,1:5,2:6,3:7,4:0,5:1,6:2,7:3}},this.config=t,this.pixelDistance=e,this.selectionPoints=i,this.midPoints=o,this.coordinatePoints=r}getClosestCoordinate(t,e){let i,o={dist:1/0,index:-1,isFirstOrLastPolygonCoord:!1};if("LineString"===e.type)i=e.coordinates;else{if("Polygon"!==e.type)return o;i=e.coordinates[0]}for(let r=0;r<i.length;r++){let s=this.pixelDistance.measure(t,i[r]);if(s<this.pointerDistance&&s<o.dist){let t="Polygon"===e.type&&(r===i.length-1||0===r);o.dist=s,o.index=t?0:r,o.isFirstOrLastPolygonCoord=t}}return o}isValidDragWebMercator(t,e,i){switch(t){case 0:if(e<=0||i>=0)return!1;break;case 1:if(i>=0)return!1;break;case 2:if(e>=0||i>=0)return!1;break;case 3:if(e>=0)return!1;break;case 4:if(e>=0||i<=0)return!1;break;case 5:if(i<=0)return!1;break;case 6:if(e<=0||i<=0)return!1;break;case 7:if(e<=0)return!1}return!0}getSelectedFeatureDataWebMercator(){if(!this.draggedCoordinate.id||-1===this.draggedCoordinate.index)return null;let t=this.getFeature(this.draggedCoordinate.id);if(!t)return null;let e=this.getNormalisedCoordinates(t.geometry);return{boundingBox:this.getBBoxWebMercator(e),feature:t,updatedCoords:e,selectedCoordinate:e[this.draggedCoordinate.index]}}centerWebMercatorDrag(t){let e=this.getSelectedFeatureDataWebMercator();if(!e)return null;let{feature:i,boundingBox:o,updatedCoords:r,selectedCoordinate:s}=e,n=tv(i);if(!n)return null;let a=m(s[0],s[1]),{closestBBoxIndex:d}=this.getIndexesWebMercator(o,a),l=m(t.lng,t.lat);return this.scaleWebMercator({closestBBoxIndex:d,updatedCoords:r,webMercatorCursor:l,webMercatorSelected:a,webMercatorOrigin:n}),r}centerFixedWebMercatorDrag(t){let e=this.getSelectedFeatureDataWebMercator();if(!e)return null;let{feature:i,boundingBox:o,updatedCoords:r,selectedCoordinate:s}=e,n=tv(i);if(!n)return null;let a=m(s[0],s[1]),{closestBBoxIndex:d}=this.getIndexesWebMercator(o,a),l=m(t.lng,t.lat);return this.scaleFixedWebMercator({closestBBoxIndex:d,updatedCoords:r,webMercatorCursor:l,webMercatorSelected:a,webMercatorOrigin:n}),r}scaleFixedWebMercator({closestBBoxIndex:t,webMercatorOrigin:e,webMercatorSelected:i,webMercatorCursor:o,updatedCoords:r}){if(!this.isValidDragWebMercator(t,e.x-o.x,e.y-o.y))return null;let s=b(e,o)/b(e,i);return s<0&&(s=this.minimumScale),tI({coordinates:r,originX:e.x,originY:e.y,xScale:s,yScale:s}),r}oppositeFixedWebMercatorDrag(t){let e=this.getSelectedFeatureDataWebMercator();if(!e)return null;let{boundingBox:i,updatedCoords:o,selectedCoordinate:r}=e,s=m(r[0],r[1]),{oppositeBboxIndex:n,closestBBoxIndex:a}=this.getIndexesWebMercator(i,s),d={x:i[n][0],y:i[n][1]},l=m(t.lng,t.lat);return this.scaleFixedWebMercator({closestBBoxIndex:a,updatedCoords:o,webMercatorCursor:l,webMercatorSelected:s,webMercatorOrigin:d}),o}oppositeWebMercatorDrag(t){let e=this.getSelectedFeatureDataWebMercator();if(!e)return null;let{boundingBox:i,updatedCoords:o,selectedCoordinate:r}=e,s=m(r[0],r[1]),{oppositeBboxIndex:n,closestBBoxIndex:a}=this.getIndexesWebMercator(i,s),d={x:i[n][0],y:i[n][1]},l=m(t.lng,t.lat);return this.scaleWebMercator({closestBBoxIndex:a,updatedCoords:o,webMercatorCursor:l,webMercatorSelected:s,webMercatorOrigin:d}),o}scaleWebMercator({closestBBoxIndex:t,webMercatorOrigin:e,webMercatorSelected:i,webMercatorCursor:o,updatedCoords:r}){let s=e.x-o.x,n=e.y-o.y;if(!this.isValidDragWebMercator(t,s,n))return null;let a=1;0!==s&&1!==t&&5!==t&&(a=1-(e.x-i.x-s)/s);let d=1;return 0!==n&&3!==t&&7!==t&&(d=1-(e.y-i.y-n)/n),this.validateScale(a,d)?(a<0&&(a=this.minimumScale),d<0&&(d=this.minimumScale),this.performWebMercatorScale(r,e.x,e.y,a,d),r):null}getFeature(t){if(null===this.draggedCoordinate.id)return null;let e=this.store.getGeometryCopy(t);return"Polygon"!==e.type&&"LineString"!==e.type?null:{id:t,type:"Feature",geometry:e,properties:{}}}getNormalisedCoordinates(t){return"Polygon"===t.type?t.coordinates[0]:t.coordinates}validateScale(t,e){let i=!isNaN(t)&&e<Number.MAX_SAFE_INTEGER,o=!isNaN(e)&&e<Number.MAX_SAFE_INTEGER;return i&&o}performWebMercatorScale(t,e,i,o,r){t.forEach(t=>{let{x:s,y:n}=m(t[0],t[1]),{lng:a,lat:d}=f(e+(s-e)*o,i+(n-i)*r);t[0]=a,t[1]=d})}getBBoxWebMercator(t){let e=[1/0,1/0,-1/0,-1/0];(t=t.map(t=>{let{x:e,y:i}=m(t[0],t[1]);return[e,i]})).forEach(([t,i])=>{t<e[0]&&(e[0]=t),i<e[1]&&(e[1]=i),t>e[2]&&(e[2]=t),i>e[3]&&(e[3]=i)});let[i,o,r,s]=e;return[[i,s],[(i+r)/2,s],[r,s],[r,s+(o-s)/2],[r,o],[(i+r)/2,o],[i,o],[i,s+(o-s)/2]]}getIndexesWebMercator(t,e){let i,o=1/0;for(let r=0;r<t.length;r++){let s=b({x:e.x,y:e.y},{x:t[r][0],y:t[r][1]});s<o&&(i=r,o=s)}if(void 0===i)throw Error("No closest coordinate found");return{oppositeBboxIndex:this.boundingBoxMaps.opposite[i],closestBBoxIndex:i}}isDragging(){return null!==this.draggedCoordinate.id}startDragging(t,e){this.draggedCoordinate={id:t,index:e}}stopDragging(){this.draggedCoordinate={id:null,index:-1}}getDraggableIndex(t,e){let i=this.store.getGeometryCopy(e),o=this.getClosestCoordinate(t,i);return -1===o.index?-1:o.index}drag(t,e,i){if(!this.draggedCoordinate.id)return!1;let o=this.getFeature(this.draggedCoordinate.id);if(!o)return!1;let r=null;if("center"===e?r=this.centerWebMercatorDrag(t):"opposite"===e?r=this.oppositeWebMercatorDrag(t):"center-fixed"===e?r=this.centerFixedWebMercatorDrag(t):"opposite-fixed"===e&&(r=this.oppositeFixedWebMercatorDrag(t)),!r)return!1;for(let t=0;t<r.length;t++){let e=r[t];if(e[0]=y(e[0],this.coordinatePrecision),e[1]=y(e[1],this.coordinatePrecision),!I(e,this.coordinatePrecision))return!1}let s=this.midPoints.getUpdated(r)||[],n=this.selectionPoints.getUpdated(r)||[],a=this.coordinatePoints.getUpdated(o.id,r)||[],d={type:o.geometry.type,coordinates:"Polygon"===o.geometry.type?[r]:r};return!(i&&!i({id:this.draggedCoordinate.id,type:"Feature",geometry:d,properties:{}},{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:tY.Provisional}).valid||(this.store.updateGeometry([{id:this.draggedCoordinate.id,geometry:d},...n,...s,...a]),0))}}let tE={deselect:"Escape",delete:"Delete",rotate:["Control","r"],scale:["Control","s"]},tM={pointerOver:"move",dragStart:"move",dragEnd:"move",insertMidpoint:"crosshair"};class tS extends c{constructor(t){super(t,!0),this.mode="select",this.allowManualDeselection=!0,this.dragEventThrottle=5,this.dragEventCount=0,this.selected=[],this.flags={},this.keyEvents=tE,this.cursors=tM,this.validations={},this.selectionPoints=void 0,this.midPoints=void 0,this.coordinateSnap=void 0,this.featuresAtMouseEvent=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.dragFeature=void 0,this.dragCoordinate=void 0,this.rotateFeature=void 0,this.scaleFeature=void 0,this.dragCoordinateResizeFeature=void 0,this.coordinatePoints=void 0,this.lineSnap=void 0,this.updateOptions(t)}updateOptions(t){if(super.updateOptions(t),this.cursors=t&&t.cursors?o({},this.cursors,t.cursors):tM,null===(null==t?void 0:t.keyEvents)?this.keyEvents={deselect:null,delete:null,rotate:null,scale:null}:null!=t&&t.keyEvents&&(this.keyEvents=o({},this.keyEvents,t.keyEvents)),void 0!==(null==t?void 0:t.dragEventThrottle)&&(this.dragEventThrottle=t.dragEventThrottle),void 0!==(null==t?void 0:t.allowManualDeselection)&&(this.allowManualDeselection=t.allowManualDeselection),null!=t&&t.flags)for(let e in this.flags=o({},this.flags,t.flags),this.validations={},this.flags){let t=this.flags[e].feature;t&&t.validation&&(this.validations[e]=t.validation)}}selectFeature(t){this.select(t,!1)}setSelecting(){if("started"!==this._state)throw Error("Mode must be started to move to selecting state");this._state="selecting"}registerBehaviors(t){this.pixelDistance=new T(t),this.clickBoundingBox=new N(t),this.featuresAtMouseEvent=new tu(t,this.clickBoundingBox,this.pixelDistance),this.selectionPoints=new th(t),this.coordinatePoints=new Q(t),this.midPoints=new tl(t,this.selectionPoints,this.coordinatePoints),this.coordinateSnap=new j(t,this.pixelDistance,this.clickBoundingBox),this.lineSnap=new X(t,this.pixelDistance,this.clickBoundingBox),this.rotateFeature=new tC(t,this.selectionPoints,this.midPoints,this.coordinatePoints),this.dragFeature=new tg(t,this.featuresAtMouseEvent,this.selectionPoints,this.midPoints,this.coordinatePoints),this.dragCoordinate=new ty(t,this.pixelDistance,this.selectionPoints,this.midPoints,this.coordinatePoints,this.coordinateSnap,this.lineSnap),this.dragCoordinateResizeFeature=new tx(t,this.pixelDistance,this.selectionPoints,this.midPoints,this.coordinatePoints),this.scaleFeature=new tP(t,this.dragCoordinateResizeFeature)}deselectFeature(){this.deselect()}deselect(){let t=this.selected.filter(t=>this.store.has(t)).map(t=>({id:t,property:r.SELECTED,value:!1}));this.store.updateProperty(t),this.onDeselect(this.selected[0]),this.selected=[],this.selectionPoints.delete(),this.midPoints.delete()}deleteSelected(){this.store.delete(this.selected),this.selected=[]}onRightClick(t){let e;if(!this.selectionPoints.ids.length)return;let i,o=1/0;if(this.selectionPoints.ids.forEach(e=>{let r=this.store.getGeometryCopy(e),s=this.pixelDistance.measure(t,r.coordinates);s<this.pointerDistance&&s<o&&(o=s,i=this.store.getPropertiesCopy(e))}),!i)return;let r=i.selectionPointFeatureId,s=i.index,n=this.store.getPropertiesCopy(r),a=this.flags[n.mode],d=this.validations[n.mode];if(!(a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.deletable))return;let l=this.store.getGeometryCopy(r);if("Polygon"===l.type){if((e=l.coordinates[0]).length<=4)return}else if("LineString"===l.type&&(e=l.coordinates).length<=2)return;if(!e||("Polygon"!==l.type||0!==s&&s!==e.length-1?e.splice(s,1):(e.shift(),e.pop(),e.push([e[0][0],e[0][1]])),d&&!d({id:r,type:"Feature",geometry:l,properties:n},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:tY.Commit}).valid))return;let h=[...this.midPoints.ids,...this.selectionPoints.ids];this.store.delete(h),this.store.updateGeometry([{id:r,geometry:l}]),n.coordinatePointIds&&this.coordinatePoints.createOrUpdate(r),this.selectionPoints.create(e,l.type,r),a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.midpoints&&this.midPoints.create(e,r,this.coordinatePrecision)}select(t,e=!0){if(this.selected[0]===t)return;let{mode:i}=this.store.getPropertiesCopy(t),o=this.flags[i];if(!o||!o.feature)return;let s=this.selected[0];if(s){if(s===t)return;this.deselect()}e&&this.setCursor(this.cursors.pointerOver),this.selected=[t],this.store.updateProperty([{id:t,property:r.SELECTED,value:!0}]),this.onSelect(t);let{type:n,coordinates:a}=this.store.getGeometryCopy(t);if("LineString"!==n&&"Polygon"!==n)return;let d="LineString"===n?a:a[0];d&&o&&o.feature.coordinates&&(this.selectionPoints.create(d,n,t),o.feature.coordinates.midpoints&&this.midPoints.create(d,t,this.coordinatePrecision))}onLeftClick(t){let{clickedFeature:e,clickedMidPoint:i}=this.featuresAtMouseEvent.find(t,this.selected.length>0);if(this.selected.length&&i)this.midPoints.insert(this.selected[0],i.id,this.coordinatePrecision);else if(e&&e.id)this.select(e.id,!0);else if(this.selected.length&&this.allowManualDeselection)return void this.deselect()}start(){this.setStarted(),this.setSelecting()}stop(){this.cleanUp(),this.setStarted(),this.setStopped()}onClick(t){"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)}canScale(t){return this.keyEvents.scale&&this.keyEvents.scale.every(e=>t.heldKeys.includes(e))}canRotate(t){return this.keyEvents.rotate&&this.keyEvents.rotate.every(e=>t.heldKeys.includes(e))}preventDefaultKeyEvent(t){let e=this.canRotate(t),i=this.canScale(t);(e||i)&&t.preventDefault()}onKeyDown(t){this.preventDefaultKeyEvent(t)}onKeyUp(t){if(this.preventDefaultKeyEvent(t),this.keyEvents.delete&&t.key===this.keyEvents.delete){if(!this.selected.length)return;let t=this.selected[0];this.onDeselect(this.selected[0]),this.coordinatePoints.deletePointsByFeatureIds([t]),this.deleteSelected(),this.selectionPoints.delete(),this.midPoints.delete()}else this.keyEvents.deselect&&t.key===this.keyEvents.deselect&&this.cleanUp()}cleanUp(){this.selected.length&&this.deselect()}onDragStart(t,e){if(!this.allowPointerEvent(this.pointerEvents.onDragStart,t)||!this.selected.length)return;let i=this.store.getPropertiesCopy(this.selected[0]),o=this.flags[i.mode];if(!(o&&o.feature&&(o.feature.draggable||o.feature.coordinates&&o.feature.coordinates.draggable||o.feature.coordinates&&o.feature.coordinates.resizable||o.feature.coordinates&&"object"==typeof o.feature.coordinates.midpoints&&o.feature.coordinates.midpoints.draggable)))return;this.dragEventCount=0;let r=this.selected[0],s=this.dragCoordinate.getDraggableIndex(t,r);if(o&&o.feature&&o.feature.coordinates&&(o.feature.coordinates.draggable||o.feature.coordinates.resizable)&&-1!==s)return this.setCursor(this.cursors.dragStart),o.feature.coordinates.resizable?this.dragCoordinateResizeFeature.startDragging(r,s):this.dragCoordinate.startDragging(r,s),void e(!1);if(o&&o.feature&&o.feature.coordinates&&"object"==typeof o.feature.coordinates.midpoints&&o.feature.coordinates.midpoints.draggable){let{clickedMidPoint:i}=this.featuresAtMouseEvent.find(t,this.selected.length>0);if(this.selected.length&&i){this.midPoints.insert(r,i.id,this.coordinatePrecision);let o=this.dragCoordinate.getDraggableIndex(t,r);return this.dragCoordinate.startDragging(r,o),void e(!1)}}return o&&o.feature&&o.feature.draggable&&this.dragFeature.canDrag(t,r)?(this.setCursor(this.cursors.dragStart),this.dragFeature.startDragging(t,r),void e(!1)):void 0}onDrag(t,e){if(!this.allowPointerEvent(this.pointerEvents.onDrag,t))return;let i=this.selected[0];if(!i)return;let o=this.store.getPropertiesCopy(i),r=this.flags[o.mode],s=!0===(r&&r.feature&&r.feature.selfIntersectable);if(this.dragEventCount++,this.dragEventCount%this.dragEventThrottle==0)return;let n=this.validations[o.mode];if(r&&r.feature&&r.feature.rotateable&&this.canRotate(t))return e(!1),void this.rotateFeature.rotate(t,i,n);if(r&&r.feature&&r.feature.scaleable&&this.canScale(t))return e(!1),void this.scaleFeature.scale(t,i,n);if(this.dragCoordinateResizeFeature.isDragging()&&r.feature&&r.feature.coordinates&&r.feature.coordinates.resizable){if("globe"===this.projection)throw Error("Globe is currently unsupported projection for resizable");return e(!1),void this.dragCoordinateResizeFeature.drag(t,r.feature.coordinates.resizable,n)}if(this.dragCoordinate.isDragging()){var a;let e=null==(a=r.feature)||null==(a=a.coordinates)?void 0:a.snappable,i={toCoordinate:!1};return!0===e?i={toCoordinate:!0}:"object"==typeof e&&(i=e),void this.dragCoordinate.drag(t,s,n,i)}this.dragFeature.isDragging()?this.dragFeature.drag(t,n):e(!0)}onDragEnd(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&(this.setCursor(this.cursors.dragEnd),this.dragCoordinate.isDragging()?this.onFinish(this.selected[0],{mode:this.mode,action:"dragCoordinate"}):this.dragFeature.isDragging()?this.onFinish(this.selected[0],{mode:this.mode,action:"dragFeature"}):this.dragCoordinateResizeFeature.isDragging()&&this.onFinish(this.selected[0],{mode:this.mode,action:"dragCoordinateResize"}),this.dragCoordinate.stopDragging(),this.dragFeature.stopDragging(),this.dragCoordinateResizeFeature.stopDragging(),this.rotateFeature.reset(),this.scaleFeature.reset(),e(!0))}onMouseMove(t){if(!this.selected.length)return void this.setCursor("unset");if(this.dragFeature.isDragging())return;let e=!1;this.midPoints.ids.forEach(i=>{if(e)return;let o=this.store.getGeometryCopy(i);this.pixelDistance.measure(t,o.coordinates)<this.pointerDistance&&(e=!0)});let i=!1;if(this.selectionPoints.ids.forEach(o=>{let r=this.store.getGeometryCopy(o);this.pixelDistance.measure(t,r.coordinates)<this.pointerDistance&&(e=!1,i=!0)}),e)return void this.setCursor(this.cursors.insertMidpoint);let{clickedFeature:o}=this.featuresAtMouseEvent.find(t,!0);this.setCursor(this.selected.length>0&&(o&&o.id===this.selected[0]||i)?this.cursors.pointerOver:"unset")}styleFeature(t){let e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if(t.properties.mode===this.mode&&"Point"===t.geometry.type){if(t.properties[r.SELECTION_POINT])return e.pointColor=this.getHexColorStylingValue(this.styles.selectionPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectionPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.selectionPointWidth,e.pointWidth,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectionPointOutlineWidth,2,t),e.zIndex=30,e;if(t.properties[r.MID_POINT])return e.pointColor=this.getHexColorStylingValue(this.styles.midPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.midPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.midPointWidth,4,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.midPointOutlineWidth,2,t),e.zIndex=50,e}else if(t.properties[r.SELECTED]){if("Point"===t.geometry.type&&t.properties[s.MARKER])return e.markerUrl=this.getUrlStylingValue(this.styles.selectedMarkerUrl,"https://raw.githubusercontent.com/JamesLMilner/terra-draw/refs/heads/main/assets/markers/marker-blue.png",t),e.markerHeight=this.getNumericStylingValue(this.styles.selectedMarkerHeight,40,t),e.markerWidth=this.getNumericStylingValue(this.styles.selectedMarkerWidth,32,t),e;if("Polygon"===t.geometry.type)return e.polygonFillColor=this.getHexColorStylingValue(this.styles.selectedPolygonColor,e.polygonFillColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.selectedPolygonOutlineWidth,e.polygonOutlineWidth,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.selectedPolygonOutlineColor,e.polygonOutlineColor,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.selectedPolygonFillOpacity,e.polygonFillOpacity,t),e.zIndex=10,e;if("LineString"===t.geometry.type)return e.lineStringColor=this.getHexColorStylingValue(this.styles.selectedLineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.selectedLineStringWidth,e.lineStringWidth,t),e.zIndex=10,e;if("Point"===t.geometry.type)return e.pointWidth=this.getNumericStylingValue(this.styles.selectedPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.selectedPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectedPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectedPointOutlineWidth,e.pointOutlineWidth,t),e.zIndex=10,e}return e}afterFeatureUpdated(t){if(this.selected.length&&t.id===this.selected[0]){var e,i;let o,r=this.flags[t.properties.mode];if(null==r||null==(e=r.feature)||!e.coordinates)return;let s=t.geometry.type,n=t.id;if(this.selectionPoints.delete(),this.midPoints.delete(),"Polygon"===s)o=t.geometry.coordinates[0];else{if("LineString"!==s)return;o=t.geometry.coordinates}this.selectionPoints.create(o,s,n),null!=r&&null!=(i=r.feature)&&null!=(i=i.coordinates)&&i.midpoints&&this.midPoints.create("Polygon"===s?t.geometry.coordinates[0]:t.geometry.coordinates,n,this.coordinatePrecision)}}}class tD extends h{constructor(...t){super(...t),this.type=tK.Static,this.mode="static"}start(){}stop(){}onKeyUp(){}onKeyDown(){}onClick(){}onDragStart(){}onDrag(){}onDragEnd(){}onMouseMove(){}cleanUp(){}styleFeature(){return o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0})}}function t_(t,e,i){let o=t[e];t[e]=t[i],t[i]=o}function tF(t,e){tb(t,0,t.children.length,e,t)}function tb(t,e,i,o,r){r||(r=tW([])),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let s=e;s<i;s++){let e=t.children[s];tO(r,t.leaf?o(e):e)}return r}function tO(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function tw(t,e){return t.minX-e.minX}function tk(t,e){return t.minY-e.minY}function tN(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function tT(t){return t.maxX-t.minX+(t.maxY-t.minY)}function tj(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function tB(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function tW(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function tG(t,e,i,o,r){let s=[e,i];for(;s.length;){if((i=s.pop())-(e=s.pop())<=o)continue;let n=e+Math.ceil((i-e)/o/2)*o;(function t(e,i,o,r,s){for(;r>o;){if(r-o>600){let n=r-o+1,a=i-o+1,d=Math.log(n),l=.5*Math.exp(2*d/3),h=.5*Math.sqrt(d*l*(n-l)/n)*(a-n/2<0?-1:1);t(e,i,Math.max(o,Math.floor(i-a*l/n+h)),Math.min(r,Math.floor(i+(n-a)*l/n+h)),s)}let n=e[i],a=o,d=r;for(t_(e,o,i),s(e[r],n)>0&&t_(e,o,r);a<d;){for(t_(e,a,d),a++,d--;0>s(e[a],n);)a++;for(;s(e[d],n)>0;)d--}0===s(e[o],n)?t_(e,o,d):t_(e,++d,r),d<=i&&(o=d+1),i<=d&&(r=d-1)}})(t,n,e,i,r),s.push(e,n,n,i)}}class tR{constructor(t){this._maxEntries=void 0,this._minEntries=void 0,this.data=void 0,this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}search(t){let e=this.data,i=[];if(!tB(t,e))return i;let o=this.toBBox,r=[];for(;e;){for(let s=0;s<e.children.length;s++){let n=e.children[s],a=e.leaf?o(n):n;tB(t,a)&&(e.leaf?i.push(n):tj(t,a)?this._all(n,i):r.push(n))}e=r.pop()}return i}collides(t){let e=this.data;if(tB(t,e)){let i=[];for(;e;){for(let o=0;o<e.children.length;o++){let r=e.children[o],s=e.leaf?this.toBBox(r):r;if(tB(t,s)){if(e.leaf||tj(t,s))return!0;i.push(r)}}e=i.pop()}}return!1}load(t){if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){let t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e}insert(t){this._insert(t,this.data.height-1)}clear(){this.data=tW([])}remove(t){let e=this.data,i=this.toBBox(t),o=[],r=[],s,n,a=!1;for(;e||o.length;){if(e||(e=o.pop(),n=o[o.length-1],s=r.pop(),a=!0),e.leaf){let i=e.children.indexOf(t);-1!==i&&(e.children.splice(i,1),o.push(e),this._condense(o))}a||e.leaf||!tj(e,i)?n?(s++,e=n.children[s],a=!1):e=null:(o.push(e),r.push(s),s=0,n=e,e=e.children[0])}}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}_all(t,e){let i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,o){let r=i-e+1,s,n=this._maxEntries;if(r<=n)return tF(s=tW(t.slice(e,i+1)),this.toBBox),s;o||(o=Math.ceil(Math.log(r)/Math.log(n)),n=Math.ceil(r/Math.pow(n,o-1))),(s=tW([])).leaf=!1,s.height=o;let a=Math.ceil(r/n),d=a*Math.ceil(Math.sqrt(n));tG(t,e,i,d,this.compareMinX);for(let r=e;r<=i;r+=d){let e=Math.min(r+d-1,i);tG(t,r,e,a,this.compareMinY);for(let i=r;i<=e;i+=a){let r=Math.min(i+a-1,e);s.children.push(this._build(t,i,r,o-1))}}return tF(s,this.toBBox),s}_chooseSubtree(t,e,i,o){for(;o.push(e),!e.leaf&&o.length-1!==i;){let i,o=1/0,r=1/0;for(let s=0;s<e.children.length;s++){let n=e.children[s],a=tN(n),d=(Math.max(n.maxX,t.maxX)-Math.min(n.minX,t.minX))*(Math.max(n.maxY,t.maxY)-Math.min(n.minY,t.minY))-a;d<r?(r=d,o=a<o?a:o,i=n):d===r&&a<o&&(o=a,i=n)}e=i||e.children[0]}return e}_insert(t,e,i){let o=i?t:this.toBBox(t),r=[],s=this._chooseSubtree(o,this.data,e,r);for(s.children.push(t),tO(s,o);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(o,r,e)}_split(t,e){let i=t[e],o=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,o);let s=this._chooseSplitIndex(i,r,o),n=tW(i.children.splice(s,i.children.length-s));n.height=i.height,n.leaf=i.leaf,tF(i,this.toBBox),tF(n,this.toBBox),e?t[e-1].children.push(n):this._splitRoot(i,n)}_splitRoot(t,e){this.data=tW([t,e]),this.data.height=t.height+1,this.data.leaf=!1,tF(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let o,r=1/0,s=1/0;for(let n=e;n<=i-e;n++){let e=tb(t,0,n,this.toBBox),a=tb(t,n,i,this.toBBox),d=function(t,e){let i=Math.max(t.minX,e.minX),o=Math.max(t.minY,e.minY);return Math.max(0,Math.min(t.maxX,e.maxX)-i)*Math.max(0,Math.min(t.maxY,e.maxY)-o)}(e,a),l=tN(e)+tN(a);d<r?(r=d,o=n,s=l<s?l:s):d===r&&l<s&&(s=l,o=n)}return o||i-e}_chooseSplitAxis(t,e,i){let o=t.leaf?this.compareMinX:tw,r=t.leaf?this.compareMinY:tk;this._allDistMargin(t,e,i,o)<this._allDistMargin(t,e,i,r)&&t.children.sort(o)}_allDistMargin(t,e,i,o){t.children.sort(o);let r=this.toBBox,s=tb(t,0,e,r),n=tb(t,i-e,i,r),a=tT(s)+tT(n);for(let o=e;o<i-e;o++){let e=t.children[o];tO(s,t.leaf?r(e):e),a+=tT(s)}for(let o=i-e-1;o>=e;o--){let e=t.children[o];tO(n,t.leaf?r(e):e),a+=tT(n)}return a}_adjustParentBBoxes(t,e,i){for(let o=i;o>=0;o--)tO(e[o],t)}_condense(t){for(let e,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():tF(t[i],this.toBBox)}}class tL{constructor(t){this.tree=void 0,this.idToNode=void 0,this.nodeToId=void 0,this.tree=new tR(t&&t.maxEntries?t.maxEntries:9),this.idToNode=new Map,this.nodeToId=new Map}setMaps(t,e){this.idToNode.set(t.id,e),this.nodeToId.set(e,t.id)}toBBox(t){let e,i=[],o=[];if("Polygon"===t.geometry.type)e=t.geometry.coordinates[0];else if("LineString"===t.geometry.type)e=t.geometry.coordinates;else{if("Point"!==t.geometry.type)throw Error("Not a valid feature to turn into a bounding box");e=[t.geometry.coordinates]}for(let t=0;t<e.length;t++)o.push(e[t][1]),i.push(e[t][0]);return{minX:Math.min(...i),minY:Math.min(...o),maxX:Math.max(...i),maxY:Math.max(...o)}}insert(t){if(this.idToNode.get(String(t.id)))throw Error("Feature already exists");let e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)}load(t){let e=[],i=new Set;t.forEach(t=>{let o=this.toBBox(t);if(this.setMaps(t,o),i.has(String(t.id)))throw Error(`Duplicate feature ID found ${t.id}`);i.add(String(t.id)),e.push(o)}),this.tree.load(e)}update(t){this.remove(t.id);let e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)}remove(t){let e=this.idToNode.get(t);if(!e)throw Error(`${t} not inserted into the spatial index`);this.tree.remove(e)}clear(){this.tree.clear()}search(t){return this.tree.search(this.toBBox(t)).map(t=>this.nodeToId.get(t))}collides(t){return this.tree.collides(this.toBBox(t))}}let tA={getId:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){let e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}),isValidId:t=>"string"==typeof t&&36===t.length};class tU{constructor(t){this.idStrategy=void 0,this.tracked=void 0,this.spatialIndex=void 0,this.store=void 0,this._onChange=()=>{},this.store={},this.spatialIndex=new tL,this.tracked=!t||!1!==t.tracked,this.idStrategy=t&&t.idStrategy?t.idStrategy:tA}clone(t){return JSON.parse(JSON.stringify(t))}getId(){return this.idStrategy.getId()}has(t){return!!this.store[t]}load(t,e,i,o){if(0===t.length)return[];let r=this.clone(t),s=[],n=[];r=r.filter(t=>{null==t.id&&(t.id=this.idStrategy.getId());let i=t.id;if(e){let o=e(t);if(!o.valid)return s.push({id:i,valid:!1,reason:o.reason}),!1}if(this.tracked){if(t.properties.createdAt){if(!d(t.properties.createdAt))return s.push({id:t.id,valid:!1,reason:"createdAt is not a valid numeric timestamp"}),!1}else t.properties.createdAt=+new Date;if(t.properties.updatedAt){if(!d(t.properties.updatedAt))return s.push({id:t.id,valid:!1,reason:"updatedAt is not a valid numeric timestamp"}),!1}else t.properties.updatedAt=+new Date}return this.has(i)?(s.push({id:i,valid:!1,reason:`Feature already exists with this id: ${i}`}),!1):(this.store[i]=t,n.push(t),s.push({id:i,valid:!0}),!0)}),this.spatialIndex.load(r);let a=n.map(({id:t})=>t);return a.length>0&&(this._onChange(a,"create",o),i&&n.forEach(t=>{i(t)})),s}search(t,e){let i=this.spatialIndex.search(t).map(t=>this.store[t]);return this.clone(e?i.filter(e):i)}registerOnChange(t){this._onChange=(e,i,o)=>{t(e,i,o)}}getGeometryCopy(t){let e=this.store[t];if(!e)throw Error(`No feature with this id (${t}), can not get geometry copy`);return this.clone(e.geometry)}getPropertiesCopy(t){let e=this.store[t];if(!e)throw Error(`No feature with this id (${t}), can not get properties copy`);return this.clone(e.properties)}updateProperty(t,e){let i=[];t.forEach(({id:t,property:e,value:o})=>{let r=this.store[t];if(!r)throw Error(`No feature with this (${t}), can not update geometry`);i.push(t),void 0===o?delete r.properties[e]:r.properties[e]=o,this.tracked&&(r.properties.updatedAt=+new Date)}),this._onChange&&this._onChange(i,"update",e)}updateGeometry(t,e){let i=[];t.forEach(({id:t,geometry:e})=>{i.push(t);let o=this.store[t];if(!o)throw Error(`No feature with this (${t}), can not update geometry`);o.geometry=this.clone(e),this.spatialIndex.update(o),this.tracked&&(o.properties.updatedAt=+new Date)}),this._onChange&&this._onChange(i,"update",e)}create(t,e){let i=[];return t.forEach(({geometry:t,properties:e})=>{let r,s=o({},e);this.tracked&&(r=+new Date,e?(s.createdAt="number"==typeof e.createdAt?e.createdAt:r,s.updatedAt="number"==typeof e.updatedAt?e.updatedAt:r):s={createdAt:r,updatedAt:r});let n=this.getId(),a={id:n,type:"Feature",geometry:t,properties:s};this.store[n]=a,this.spatialIndex.insert(a),i.push(n)}),this._onChange&&this._onChange([...i],"create",e),i}delete(t,e){t.forEach(t=>{if(!this.store[t])throw Error(`No feature with id ${t}, can not delete`);delete this.store[t],this.spatialIndex.remove(t)}),this._onChange&&this._onChange([...t],"delete",e)}copy(t){return this.clone(this.store[t])}copyAll(){return this.clone(Object.keys(this.store).map(t=>this.store[t]))}copyAllWhere(t){return this.clone(Object.keys(this.store).map(t=>this.store[t]).filter(e=>e.properties&&t(e.properties)))}clear(){this.store={},this.spatialIndex.clear()}size(){return Object.keys(this.store).length}}class tV{constructor({name:t,callback:e,unregister:i,register:o}){this.name=void 0,this.callback=void 0,this.registered=!1,this.register=void 0,this.unregister=void 0,this.name=t,this.register=()=>{this.registered||(this.registered=!0,o(e))},this.unregister=()=>{this.register&&(this.registered=!1,i(e))},this.callback=e}}var tY,tK,tX={__proto__:null,GeoJSONStore:tU,TerraDrawBaseDrawMode:h,TerraDrawBaseSelectMode:c,TerraDrawBaseAdapter:class{constructor(t){this._nextKeyUpIsContextMenu=!1,this._lastPointerDownEventTarget=void 0,this._ignoreMismatchedPointerEvents=!1,this._minPixelDragDistance=void 0,this._minPixelDragDistanceDrawing=void 0,this._minPixelDragDistanceSelecting=void 0,this._lastDrawEvent=void 0,this._coordinatePrecision=void 0,this._heldKeys=new Set,this._listeners=[],this._dragState="not-dragging",this._currentModeCallbacks=void 0,this._ignoreMismatchedPointerEvents="boolean"==typeof t.ignoreMismatchedPointerEvents&&t.ignoreMismatchedPointerEvents,this._minPixelDragDistance="number"==typeof t.minPixelDragDistance?t.minPixelDragDistance:1,this._minPixelDragDistanceSelecting="number"==typeof t.minPixelDragDistanceSelecting?t.minPixelDragDistanceSelecting:1,this._minPixelDragDistanceDrawing="number"==typeof t.minPixelDragDistanceDrawing?t.minPixelDragDistanceDrawing:8,this._coordinatePrecision="number"==typeof t.coordinatePrecision?t.coordinatePrecision:9}getButton(t){return -1===t.button?"neither":0===t.button?"left":1===t.button?"middle":2===t.button?"right":"neither"}getMapElementXYPosition(t){let{left:e,top:i}=this.getMapEventElement().getBoundingClientRect();return{containerX:t.clientX-e,containerY:t.clientY-i}}getDrawEventFromEvent(t,e=!1){let i=this.getLngLatFromEvent(t);if(!i)return null;let{lng:o,lat:r}=i,{containerX:s,containerY:n}=this.getMapElementXYPosition(t),a=this.getButton(t),d=Array.from(this._heldKeys);return{lng:y(o,this._coordinatePrecision),lat:y(r,this._coordinatePrecision),containerX:s,containerY:n,button:a,heldKeys:d,isContextMenu:e}}register(t){this._currentModeCallbacks=t,this._listeners=this.getAdapterListeners(),this._listeners.forEach(t=>{t.register()})}getCoordinatePrecision(){return this._coordinatePrecision}getAdapterListeners(){return[new tV({name:"pointerdown",callback:t=>{if(!this._currentModeCallbacks||!t.isPrimary)return;let e=this.getDrawEventFromEvent(t);e&&(this._dragState="pre-dragging",this._lastDrawEvent=e,this._lastPointerDownEventTarget=t.target?t.target:void 0)},register:t=>{this.getMapEventElement().addEventListener("pointerdown",t)},unregister:t=>{this.getMapEventElement().removeEventListener("pointerdown",t)}}),new tV({name:"pointermove",callback:t=>{if(!this._currentModeCallbacks||!t.isPrimary)return;t.preventDefault();let e=this.getDrawEventFromEvent(t);if(e)if("not-dragging"===this._dragState)this._currentModeCallbacks.onMouseMove(e),this._lastDrawEvent=e;else if("pre-dragging"===this._dragState){if(!this._lastDrawEvent)return;let t={x:this._lastDrawEvent.containerX,y:this._lastDrawEvent.containerY},i={x:e.containerX,y:e.containerY},o=this._currentModeCallbacks.getState(),r=b(t,i);if("drawing"===o?r<this._minPixelDragDistanceDrawing:"selecting"===o?r<this._minPixelDragDistanceSelecting:r<this._minPixelDragDistance)return;this._nextKeyUpIsContextMenu=!1,this._dragState="dragging",this._currentModeCallbacks.onDragStart(e,t=>{this.setDraggability.bind(this)(t)})}else"dragging"===this._dragState&&this._currentModeCallbacks.onDrag(e,t=>{this.setDraggability.bind(this)(t)})},register:t=>{this.getMapEventElement().addEventListener("pointermove",t)},unregister:t=>{this.getMapEventElement().removeEventListener("pointermove",t)}}),new tV({name:"contextmenu",callback:t=>{this._currentModeCallbacks&&(t.preventDefault(),this._nextKeyUpIsContextMenu=!0)},register:t=>{this.getMapEventElement().addEventListener("contextmenu",t)},unregister:t=>{this.getMapEventElement().removeEventListener("contextmenu",t)}}),new tV({name:"pointerup",callback:t=>{if(!this._currentModeCallbacks||t.target!==this.getMapEventElement()||this._ignoreMismatchedPointerEvents&&this._lastPointerDownEventTarget!==t.target||(this._lastPointerDownEventTarget=void 0,!t.isPrimary))return;let e=this.getDrawEventFromEvent(t);e&&("dragging"===this._dragState?this._currentModeCallbacks.onDragEnd(e,t=>{this.setDraggability.bind(this)(t)}):"not-dragging"!==this._dragState&&"pre-dragging"!==this._dragState||(this._nextKeyUpIsContextMenu&&(e.isContextMenu=!0,this._nextKeyUpIsContextMenu=!1),this._currentModeCallbacks.onClick(e)),this._dragState="not-dragging",this.setDraggability(!0))},register:t=>{this.getMapEventElement().addEventListener("pointerup",t)},unregister:t=>{this.getMapEventElement().removeEventListener("pointerup",t)}}),new tV({name:"keyup",callback:t=>{this._currentModeCallbacks&&(this._heldKeys.delete(t.key),this._currentModeCallbacks.onKeyUp({key:t.key,heldKeys:Array.from(this._heldKeys),preventDefault:()=>t.preventDefault()}))},register:t=>{this.getMapEventElement().addEventListener("keyup",t)},unregister:t=>{this.getMapEventElement().removeEventListener("keyup",t)}}),new tV({name:"keydown",callback:t=>{this._currentModeCallbacks&&(this._heldKeys.add(t.key),this._currentModeCallbacks.onKeyDown({key:t.key,heldKeys:Array.from(this._heldKeys),preventDefault:()=>t.preventDefault()}))},register:t=>{this.getMapEventElement().addEventListener("keydown",t)},unregister:t=>{this.getMapEventElement().removeEventListener("keydown",t)}})]}unregister(){this._listeners.forEach(t=>{t.unregister()}),this.clear(),this._currentModeCallbacks=void 0,this._lastDrawEvent=void 0,this._lastPointerDownEventTarget=void 0,this._nextKeyUpIsContextMenu=!1}},getDefaultStyling:()=>({polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0}),SELECT_PROPERTIES:r};class tz{constructor(t){this._modes=void 0,this._mode=void 0,this._adapter=void 0,this._enabled=!1,this._store=void 0,this._eventListeners=void 0,this._instanceSelectMode=void 0,this._adapter=t.adapter,this._mode=new tD;let e=new Set,i=t.modes.reduce((t,i)=>{if(e.has(i.mode))throw Error(`There is already a ${i.mode} mode provided`);return e.add(i.mode),t[i.mode]=i,t},{}),r=Object.keys(i);if(0===r.length)throw Error("No modes provided");r.forEach(t=>{if(i[t].type===tK.Select){if(this._instanceSelectMode)throw Error("only one type of select mode can be provided");this._instanceSelectMode=t}}),this._modes=o({},i,{static:this._mode}),this._eventListeners={change:[],select:[],deselect:[],finish:[],ready:[]},this._store=new tU({tracked:!!t.tracked,idStrategy:t.idStrategy?t.idStrategy:void 0});let s=t=>{let e=[],i=this._store.copyAll().filter(i=>!t.includes(i.id)||(e.push(i),!1));return{changed:e,unchanged:i}},n=(t,e)=>{this._enabled&&this._eventListeners.finish.forEach(i=>{i(t,e)})},a=(t,e,i)=>{if(!this._enabled)return;this._eventListeners.change.forEach(o=>{o(t,e,i)});let{changed:o,unchanged:r}=s(t);"create"===e?this._adapter.render({created:o,deletedIds:[],unchanged:r,updated:[]},this.getModeStyles()):"update"===e?this._adapter.render({created:[],deletedIds:[],unchanged:r,updated:o},this.getModeStyles()):"delete"===e?this._adapter.render({created:[],deletedIds:t,unchanged:r,updated:[]},this.getModeStyles()):"styling"===e&&this._adapter.render({created:[],deletedIds:[],unchanged:r,updated:[]},this.getModeStyles())},d=t=>{if(!this._enabled)return;this._eventListeners.select.forEach(e=>{e(t)});let{changed:e,unchanged:i}=s([t]);this._adapter.render({created:[],deletedIds:[],unchanged:i,updated:e},this.getModeStyles())},l=t=>{if(!this._enabled)return;this._eventListeners.deselect.forEach(t=>{t()});let{changed:e,unchanged:i}=s([t]);e&&this._adapter.render({created:[],deletedIds:[],unchanged:i,updated:e},this.getModeStyles())};Object.keys(this._modes).forEach(t=>{this._modes[t].register({mode:t,store:this._store,setCursor:this._adapter.setCursor.bind(this._adapter),project:this._adapter.project.bind(this._adapter),unproject:this._adapter.unproject.bind(this._adapter),setDoubleClickToZoom:this._adapter.setDoubleClickToZoom.bind(this._adapter),onChange:a,onSelect:d,onDeselect:l,onFinish:n,coordinatePrecision:this._adapter.getCoordinatePrecision()})})}checkEnabled(){if(!this._enabled)throw Error("Terra Draw is not enabled")}getModeStyles(){let t={};return Object.keys(this._modes).forEach(e=>{t[e]=t=>this._instanceSelectMode&&t.properties[r.SELECTED]?this._modes[this._instanceSelectMode].styleFeature.bind(this._modes[this._instanceSelectMode])(t):this._modes[e].styleFeature.bind(this._modes[e])(t)}),t}featuresAtLocation({lng:t,lat:e},i){let o=i&&void 0!==i.pointerDistance?i.pointerDistance:30,n=!i||void 0===i.ignoreSelectFeatures||i.ignoreSelectFeatures,a=!(!i||void 0===i.ignoreCoordinatePoints)&&i.ignoreCoordinatePoints,d=!(!i||void 0===i.ignoreCurrentlyDrawing)&&i.ignoreCurrentlyDrawing,l=!(!i||void 0===i.ignoreClosingPoints)&&i.ignoreClosingPoints,h=!(!i||void 0===i.ignoreSnappingPoints)&&i.ignoreSnappingPoints,c=this._adapter.unproject.bind(this._adapter),u=this._adapter.project.bind(this._adapter),g=u(t,e),y=k({unproject:c,point:g,pointerDistance:o});return this._store.search(y).filter(c=>{if(n&&(c.properties[r.MID_POINT]||c.properties[r.SELECTION_POINT])||a&&c.properties[s.COORDINATE_POINT]||l&&c.properties[s.CLOSING_POINT]||d&&c.properties[s.CURRENTLY_DRAWING]||h&&c.properties[s.SNAPPING_POINT])return!1;if("Point"===c.geometry.type){let t=c.geometry.coordinates;return b(g,u(t[0],t[1]))<o}if("LineString"===c.geometry.type){let t=c.geometry.coordinates;for(let e=0;e<t.length-1;e++){let i=t[e],r=t[e+1];if(tp(g,u(i[0],i[1]),u(r[0],r[1]))<o)return!0}return!1}if(tc([t,e],c.geometry.coordinates))return!0;if(null!=i&&i.includePolygonsWithinPointerDistance)for(let t of c.geometry.coordinates)for(let e=0;e<t.length-1;e++){let i=t[e],r=t[e+1];if(tp(g,u(i[0],i[1]),u(r[0],r[1]))<o)return!0}return!1}).map(o=>{let r;if(null==i||!i.addClosestCoordinateInfoToProperties)return o;if("Polygon"===o.geometry.type)r=o.geometry.coordinates[0].slice(0,-1);else{if("LineString"!==o.geometry.type)return o;r=o.geometry.coordinates}let s,n=-1,a=1/0;for(let t=0;t<r.length;t++){let e=r[t],i=b(u(e[0],e[1]),g);i<a&&(n=t,a=i,s=e)}return o.properties.closestCoordinateIndexToEvent=n,o.properties.closestCoordinatePixelDistanceToEvent=a,o.properties.closestCoordinateDistanceKmToEvent=p(s,[t,e]),o})}getSelectModeOrThrow(){let t=this.getSelectMode({switchToSelectMode:!0});if(!t)throw Error("No select mode defined in instance");return t}getSelectMode({switchToSelectMode:t}){if(this.checkEnabled(),!this._instanceSelectMode)return null;let e=this.getMode();return t&&e!==this._instanceSelectMode&&this.setMode(this._instanceSelectMode),this._modes[this._instanceSelectMode]}isGuidanceFeature(t){return!!(t.properties[r.MID_POINT]||t.properties[r.SELECTION_POINT]||t.properties[s.COORDINATE_POINT]||t.properties[s.SNAPPING_POINT])}setModeStyles(t,e){if(this.checkEnabled(),!this._modes[t])throw Error("No mode with this name present");this._modes[t].styles=e}updateModeOptions(t,e){if(this.checkEnabled(),!this._modes[t])throw Error("No mode with this name present");this._modes[t].updateOptions(e)}getSnapshot(){return this._store.copyAll()}getSnapshotFeature(t){if(this._store.has(t))return this._store.copy(t)}clear(){this.checkEnabled(),this._adapter.clear()}get enabled(){return this._enabled}set enabled(t){throw Error("Enabled is read only")}getMode(){return this._mode.mode}getModeState(){return this._mode.state}setMode(t){if(this.checkEnabled(),!this._modes[t])throw Error("No mode with this name present");this._mode.stop(),this._mode=this._modes[t],this._mode.start()}removeFeatures(t){this.checkEnabled();let e=[];t.forEach(t=>{if(!this._store.has(t))throw Error(`No feature with id ${t}, can not delete`);let i=this._store.copy(t);i.properties[r.SELECTED]&&this.deselectFeature(t),i.properties[s.COORDINATE_POINT_IDS]&&e.push(...i.properties[s.COORDINATE_POINT_IDS])}),this._store.delete([...t,...e],{origin:"api"})}selectFeature(t){this.getSelectModeOrThrow().selectFeature(t)}deselectFeature(t){this.getSelectModeOrThrow().deselectFeature(t)}getFeatureId(){return this._store.getId()}hasFeature(t){return this._store.has(t)}checkIsReservedProperty(t){return![...Object.values(r),...Object.values(s)].includes(t)}updateFeatureProperties(t,e){if(!this._store.has(t))throw Error(`No feature with id ${t} present in store`);let i=this._store.copy(t);if(this.isGuidanceFeature(i))throw Error("Guidance features are not allowed to be updated directly.");let o=i.properties.mode;if(!this._modes[o])throw Error(`No mode with name ${o} present in instance`);let r=Object.entries(e);r.forEach(([t,e])=>{if(!this.checkIsReservedProperty(t))throw Error(`You are trying to update a reserved property name: ${t}. Please choose another name.`);if(void 0!==e&&!function t(e){if(null===e||"boolean"==typeof e||"string"==typeof e)return!0;if(void 0===e)return!1;if("number"==typeof e)return Number.isFinite(e);if("bigint"==typeof e||"symbol"==typeof e||"function"==typeof e||e instanceof RegExp||e instanceof Map||e instanceof Set||e instanceof Date)return!1;if("object"==typeof e&&null!==e&&!Array.isArray(e)){let t=Object.getPrototypeOf(e);if(t!==Object.prototype&&null!==t)return!1}if(ArrayBuffer.isView(e)&&!(e instanceof DataView))return!1;if(Array.isArray(e)){for(let i of e)if(!t(i))return!1}return"object"==typeof e&&Object.keys(e).every(i=>"string"==typeof i&&t(e[i]))}(e))throw Error(`Invalid JSON value provided for property ${t}`)}),this._store.updateProperty(r.map(([t,e])=>({id:i.id,property:t,value:e})),{origin:"api"})}updateFeatureGeometry(t,e){if(!this._store.has(t))throw Error(`No feature with id ${t} present in store`);let i=this._store.copy(t);if(this.isGuidanceFeature(i))throw Error("Guidance features are not allowed to be updated directly.");if(!(i&&e&&e.type&&e.coordinates))throw Error("Invalid geometry provided");if(e.type!==i.geometry.type)throw Error(`Geometry type mismatch: expected ${i.geometry.type}, got ${e.type}`);let s=i.properties.mode,n=this._modes[s];if(!n)throw Error(`No mode with name ${s} present in instance`);let a=o({},i,{geometry:e}),d=n.validateFeature(a);if(!d.valid)throw Error(`Feature validation failed: ${d.reason||"Unknown reason"}`);if(this._store.updateGeometry([{id:i.id,geometry:e}],{origin:"api"}),n.afterFeatureUpdated){n.afterFeatureUpdated(a);let t=a.properties[r.SELECTED],e=this.getSelectMode({switchToSelectMode:!1});e&&t&&e.afterFeatureUpdated(a)}}transformFeatureGeometry(t,e){let i;if(!this._store.has(t))throw Error(`No feature with id ${t} present in store`);let o=this._store.copy(t);if(this.isGuidanceFeature(o))throw Error("Guidance features are not allowed to be updated directly.");let s=o.properties.mode,n=this._modes[s];if(!n)throw Error(`No mode with name ${s} present in instance`);if("Polygon"===o.geometry.type)i=o.geometry.coordinates[0];else{if("LineString"!==o.geometry.type)throw Error(`Feature geometry type ${o.geometry.type} is not supported for transformation`);i=o.geometry.coordinates}if("web-mercator"!=e.projection)throw Error(`Projection ${e.projection} is not currently supported for transformation`);if("scale"===e.type){let{x:t,y:o}=m(e.origin[0],e.origin[1]);tI({coordinates:i,originX:t,originY:o,xScale:e.options.xScale||1,yScale:e.options.yScale||1})}else"rotate"===e.type&&(i="Polygon"===(o=tf(o,e.options.angle||0)).geometry.type?o.geometry.coordinates[0]:o.geometry.coordinates);if(i=i.map(t=>[y(t[0],this._adapter.getCoordinatePrecision()),y(t[1],this._adapter.getCoordinatePrecision())]),o.geometry.coordinates="Polygon"===o.geometry.type?[i]:i,this._store.updateGeometry([{id:o.id,geometry:o.geometry}],{origin:"api"}),n.afterFeatureUpdated){n.afterFeatureUpdated(o);let t=o.properties[r.SELECTED],e=this.getSelectMode({switchToSelectMode:!1});e&&t&&e.afterFeatureUpdated(o)}}addFeatures(t){return this.checkEnabled(),0===t.length?[]:this._store.load(t,t=>{if(a(t)){let e=t.properties.mode,i=this._modes[e];if(!i)return{id:t.id,valid:!1,reason:`${e} mode is not in the list of instantiated modes`};let o=i.validateFeature.bind(i)(t);return{id:t.id,valid:o.valid,reason:o.reason?o.reason:o.valid?void 0:"Feature is invalid"}}return{id:t.id,valid:!1,reason:"Mode property does not exist"}},t=>{if(a(t)){let e=this._modes[t.properties.mode];e&&e.afterFeatureAdded&&e.afterFeatureAdded(t)}},{origin:"api"})}start(){this._enabled||(this._enabled=!0,this._adapter.register({onReady:()=>{this._eventListeners.ready.forEach(t=>{t()})},getState:()=>this._mode.state,onClick:t=>{this._mode.onClick(t)},onMouseMove:t=>{this._mode.onMouseMove(t)},onKeyDown:t=>{this._mode.onKeyDown(t)},onKeyUp:t=>{this._mode.onKeyUp(t)},onDragStart:(t,e)=>{this._mode.onDragStart(t,e)},onDrag:(t,e)=>{this._mode.onDrag(t,e)},onDragEnd:(t,e)=>{this._mode.onDragEnd(t,e)},onClear:()=>{this._mode.cleanUp(),this._store.clear()}}))}getFeaturesAtLngLat(t,e){let{lng:i,lat:o}=t;return this.featuresAtLocation({lng:i,lat:o},e)}getFeaturesAtPointerEvent(t,e){let i=this._adapter.getLngLatFromEvent.bind(this._adapter)(t);return null===i?[]:this.featuresAtLocation(i,e)}stop(){this._enabled&&(this._enabled=!1,this._adapter.unregister())}on(t,e){let i=this._eventListeners[t];i.includes(e)||i.push(e)}off(t,e){let i=this._eventListeners[t];i.includes(e)&&i.splice(i.indexOf(e),1)}}}}]);